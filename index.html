<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <meta name="google-site-verification" content="mRjQM6azHRnllmCObIorLO1p8dqt92U33mbEzoA2HnU">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.gagahappy.com","root":"/","images":"/images","scheme":"Gemini","version":"8.6.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
<meta property="og:type" content="website">
<meta property="og:title" content="睡月花儿">
<meta property="og:url" content="https://www.gagahappy.com/">
<meta property="og:site_name" content="睡月花儿">
<meta property="og:description" content="后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
<meta property="og:locale">
<meta property="article:author" content="戛戛Happy">
<meta property="article:tag" content="后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.gagahappy.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>睡月花儿</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-17621945-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-17621945-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/rss2.xml" title="睡月花儿" type="application/rss+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">睡月花儿</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-blog"><a href="https://blog.gagahappy.cn/" rel="noopener" target="_blank"><i class="fa fa-coffee fa-fw"></i>Blog</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">11</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Posts<span class="badge">61</span></a></li>
        <li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li>
        <li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="戛戛Happy"
      src="/apple-touch-icon.png">
  <p class="site-author-name" itemprop="name">戛戛Happy</p>
  <div class="site-description" itemprop="description">后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby</div>
</div>
  <div class="">

  <div class="">

      <div class="social-item">
        <a target="_blank" class="social-link" href="/rss2.xml">
          <span class="icon">
            <i class="fa fa-rss"></i>
          </span>

          <span class="label">RSS</span>
        </a>
      </div>
  </div>
</div>

  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/golang-test-example/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
      <meta itemprop="description" content="后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/golang-test-example/" class="post-title-link" itemprop="url">go 语言 测试 示例函数</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-08-12 17:23:22" itemprop="dateCreated datePublished" datetime="2021-08-12T17:23:22+00:00">2021-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/golang/" itemprop="url" rel="index"><span itemprop="name">golang</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="示例函数"><a href="#示例函数" class="headerlink" title="示例函数"></a>示例函数</h1><p>以<code>Example</code>开头，后面加对应的函数名，示例没有参数列表与返回值列表</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">ExampleFibMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>后缀<code>FibMap</code>的首字母是大写，因为这个函数在源码中就是大写，必须与源码保持一致，如果写为<code>fibMap</code>，那么会提示<code> ExampleFibWithMap refers an unknown identifier</code>，即无法与对应的函数相关联。</p>
<p>要注意的是，因为<code>FibMap</code>方法是可导出的，它的示例函数要写为<code>ExampleFibMap</code>，如果方法是不可导出的，那么它的示例函数要写为<code>Example_xxx</code>的形式，如<code>fibWithMap</code>方法的示例函数可以命名为<code>Example_fibWithMap</code></p>
<h1 id="命名约定"><a href="#命名约定" class="headerlink" title="命名约定"></a>命名约定</h1><p>Go 语言通过大量的命名约定来简化工具的复杂度，规范代码的风格。对示例函数的命名有如下约定：</p>
<ul>
<li>包级别的示例函数，直接命名为 <code>func Example() &#123; ... &#125;</code></li>
<li>函数 F 的示例，命名为 <code>func ExampleF() &#123; ... &#125;</code></li>
<li>类型 T 的示例，命名为 <code>func ExampleT() &#123; ... &#125;</code></li>
<li>类型 T 上的 方法 M 的示例，命名为 <code>func ExampleT_M() &#123; ... &#125;</code></li>
</ul>
<p>如果同一个方法需要提供多个示例，可以在示例函数名称后附加一个不同的后缀来实现，但这种后缀必须以小写字母开头</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">Example_suffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">ExampleF_suffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">ExampleT_suffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">ExampleT_M_suffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<p>示例代码会放在单独的示例文件中，如<code>example_test.go</code></p>
<p><a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/master/src/bytes/example_test.go">https://github.com/golang/go/blob/master/src/bytes/example_test.go</a></p>
<h1 id="测试示例函数"><a href="#测试示例函数" class="headerlink" title="测试示例函数"></a>测试示例函数</h1><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 测试通过</span>
<span class="token keyword">go</span> test gott<span class="token operator">/</span>fib <span class="token operator">-</span>run<span class="token operator">=</span>ExampleFibMap
ok      gott<span class="token operator">/</span>fib        <span class="token number">0.008</span>s

<span class="token comment">// 测试不通过</span>
<span class="token keyword">go</span> test gott<span class="token operator">/</span>fib <span class="token operator">-</span>run<span class="token operator">=</span>ExampleFibMap
<span class="token operator">--</span><span class="token operator">-</span> FAIL<span class="token punctuation">:</span> ExampleFibMap <span class="token punctuation">(</span><span class="token number">0.00</span>s<span class="token punctuation">)</span>
got<span class="token punctuation">:</span>
<span class="token number">102334155</span>
want<span class="token punctuation">:</span> <span class="token comment">// 这里就是output 后面期待的值</span>
<span class="token number">102334156</span>
FAIL
FAIL    gott<span class="token operator">/</span>fib        <span class="token number">0.012</span>s
FAIL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有时候，输出顺序可能不确定，比如循环输出 map 的值，那么可以使用 <code>Unordered output</code> 开头的注释</p>
<h1 id="示例函数的作用"><a href="#示例函数的作用" class="headerlink" title="示例函数的作用"></a>示例函数的作用</h1><ol>
<li><p>作为文档使用</p>
<p>它可以直观的展示一个函数的用法与功能。根据<code>Example</code>的后缀部分，<code>godoc</code>文档服务会把示例函数关联到函数本身，在查询在线文档的时候，可以看到函数的具体用法及示例函数</p>
</li>
<li><p>验证函数是否正确</p>
<p>如果示例函数中包含<code>// Output</code>注释，那么在执行 go test 的时候，示例函数也会被运行，然后检查标准输出是否与注释匹配，不匹配则做为测试失败处理。如果示例函数中没有包含<code>// Output</code>注释，那么 go test 的时候，它不会被运行</p>
</li>
</ol>
<h1 id="源码文件"><a href="#源码文件" class="headerlink" title="源码文件"></a>源码文件</h1><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// fib_text.go</span>
<span class="token keyword">func</span> <span class="token function">ExampleFibMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	num <span class="token operator">:=</span> <span class="token function">fibWithMap</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
	<span class="token comment">//Output:</span>
	<span class="token comment">//102334155</span>
	<span class="token comment">//hello</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">Example_fibWithMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	num <span class="token operator">:=</span> <span class="token function">fibWithMap</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
	<span class="token comment">//Output:</span>
	<span class="token comment">//102334155</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以有多个标准输出，与之对应的output也要有多个注释</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">FibMap</span><span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">fibWithMap</span><span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/golang-test-convention/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
      <meta itemprop="description" content="后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/golang-test-convention/" class="post-title-link" itemprop="url">go 语言 测试惯例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-24 15:37:16" itemprop="dateCreated datePublished" datetime="2021-07-24T15:37:16+00:00">2021-07-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/golang/" itemprop="url" rel="index"><span itemprop="name">golang</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="运行某个包的测试"><a href="#运行某个包的测试" class="headerlink" title="运行某个包的测试"></a>运行某个包的测试</h1><p>不指定包名：go test 命令如果没有参数指定包，默认使用当前目录对应的包运行测试，且测试结果不会被缓存。第二次运行测试，测试结果中没有包含(cached)标示，说明测试结果没有被缓存，每次执行都会重新构建测试</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># gott/hello 当前目录为包名为 hello的目录</span>
go <span class="token builtin class-name">test</span>
PASS
ok  	gott/hello	<span class="token number">1</span>.025s

go <span class="token builtin class-name">test</span>
ok  	gott/hello	<span class="token number">1</span>.025s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>指定包名：测试结果会被缓存</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> gott/hello
ok  	gott/hello	<span class="token punctuation">(</span>cached<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h1 id="运行所有测试"><a href="#运行所有测试" class="headerlink" title="运行所有测试"></a>运行所有测试</h1><p>使用<code>go test ./...</code>标记运行所有包的测试，测试结果会被缓存</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> ./<span class="token punctuation">..</span>.
ok  	gott/hello	<span class="token number">1</span>.026s
ok  	gott/hi	<span class="token number">0</span>.040s
ok  	gott/pprint	<span class="token number">0</span>.017s
ok  	gott/prime	<span class="token number">0</span>.014s

go <span class="token builtin class-name">test</span> ./<span class="token punctuation">..</span>.
ok  	gott/hello	<span class="token punctuation">(</span>cached<span class="token punctuation">)</span>
ok  	gott/hi	<span class="token punctuation">(</span>cached<span class="token punctuation">)</span>
ok  	gott/pprint	<span class="token punctuation">(</span>cached<span class="token punctuation">)</span>
ok  	gott/prime	<span class="token punctuation">(</span>cached<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="有效的记录测试失败信息"><a href="#有效的记录测试失败信息" class="headerlink" title="有效的记录测试失败信息"></a>有效的记录测试失败信息</h1><p>测试失败的信息一般的形式是“f(x) = y, want z”，其中f(x)解释了失败的操作和对应的输入，y是实际的运行结果，z是期望的正确的结果。比起那些失败就打印满屏的堆栈信息的错误日志，这种记录格式使得测试人员很容易定位到问题所在，甚至都不需要去看源码文件。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">got <span class="token operator">:=</span> <span class="token function">sum</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> x2<span class="token punctuation">)</span>
<span class="token keyword">if</span> got <span class="token operator">!=</span> want <span class="token punctuation">&#123;</span>
	t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"sum(%d, %d) = %d, want %d"</span><span class="token punctuation">,</span> x1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> got<span class="token punctuation">,</span> want<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="随机测试如何预判结果"><a href="#随机测试如何预判结果" class="headerlink" title="随机测试如何预判结果"></a>随机测试如何预判结果</h1><p>一种方法是编写另一个对照函数，使用简单和清晰的算法，虽然效率较低但是行为和要测试的函数是一致的，然后针对相同的随机输入检查两者的输出结果。</p>
<p>第二种是生成的随机输入的数据遵循特定的模式，这样我们就可以知道期望的输出的模式。比如基于随机种子生成需要的大量数据，测试日志中不用去记录这些大量的数据，只需要记录这个随机种子即可，之后可以根据这个种子重现失败的测试用例，查找代码问题所在</p>
<h1 id="测试中的异常"><a href="#测试中的异常" class="headerlink" title="测试中的异常"></a>测试中的异常</h1><p>在测试代码中不要调用 <code>log.Fatal</code> 或 <code>os.Exit</code> ，调用这类函数会导致整个测试提前退出，后面的测试都将无法运行。调用这些函数的特权应该放在 <code>main</code> 函数中。如果真的有意外发生导致测试过程中发生 <code>panic</code> 异常，那么在测试中应该尝试用 <code>recover</code> 捕获异常，并记录下来，然后将当前测试当作失败处理(即调用<code>t.Effor/t.Fail/t.FailNow之类的方法</code>)。</p>
<p>在运行测试的时候，应该确保所有测试都得到运行，这样当测试运行结束后，就可以得到所有失败的测试用例的信息，而不是在某个测试失败后，就停止运行其后面的测试。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TestLogFatal</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"Test encounter a fatal"</span><span class="token punctuation">)</span>
	<span class="token comment">// os.Exit(2)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">TestPrint</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"just Print"</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">"GOROOT"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>由于调用了<code>log.Fatal</code>或<code>os.Exit</code>，在<code>TestLogFatal()</code>后面的测试用例都不会被运行</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> -v  gott/hello
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestLogFatal
<span class="token number">2021</span>/07/24 <span class="token number">17</span>:34:02 Test encounter a fatal
FAIL    gott/hello      <span class="token number">0</span>.007s
FAIL
<span class="token comment"># 没有打印 TestPrint()的测试日志</span>

<span class="token comment"># 把 TestPrint()放到 TestLogFatal()的前面</span>
 go <span class="token builtin class-name">test</span> -v  gott/hello
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestPrint
    hello_test.go:24: just Print
    hello_test.go:25: /Users/ga/m/opt/go/go_root
--- PASS: TestPrint <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestLogFatal
<span class="token number">2021</span>/07/24 <span class="token number">17</span>:37:04 Test encounter a fatal
FAIL    gott/hello      <span class="token number">0</span>.013s
FAIL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>TestPrint 可以运行，但 TestLogFatal 之后的测试用例都不会得到运行，在调用 log.Fatal 函数后，整个测试程序就退出了</p>
<h1 id="mock-测试中的敏感对象"><a href="#mock-测试中的敏感对象" class="headerlink" title="mock 测试中的敏感对象"></a>mock 测试中的敏感对象</h1><ul>
<li><p>对外部环境的依赖</p>
<p>数据库的连接，第三方接口的调用</p>
</li>
<li><p>导致生产代码产生一些调试信息的钩子函数</p>
</li>
<li><p>诱导生产代码进入某些重要状态的改变</p>
<p>超时、错误，甚至是一些刻意制造的并发行为等因素</p>
</li>
</ul>
<p>应该对以上这些对象进行仿造(mock)，从而得到一个纯净的测试环境。有一个需要注意的地方，如果在某个测试用例中mock了某些对象，在这个测试用例运行完成后，要对这些mock的对象进行还原，以避免影响其它测试用例。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TestCheckQuotaNotifiesUser</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Save and restore original notifyUser.</span>
  	<span class="token comment">// 保存 及 恢复 mock的原始对象</span>
    saved <span class="token operator">:=</span> notifyUser
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> notifyUser <span class="token operator">=</span> saved <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Install the test's fake notifyUser.</span>
    <span class="token keyword">var</span> notifiedUser<span class="token punctuation">,</span> notifiedMsg <span class="token builtin">string</span>
    notifyUser <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> msg <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        notifiedUser<span class="token punctuation">,</span> notifiedMsg <span class="token operator">=</span> user<span class="token punctuation">,</span> msg
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// ...rest of test...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>先把要mock的对象保存起来，等测试完成后，再对其进行恢复，可以使用<code>defer</code>语句来延后执行处理恢复的代码</p>
<h1 id="避免脆弱的测试"><a href="#避免脆弱的测试" class="headerlink" title="避免脆弱的测试"></a>避免脆弱的测试</h1><ul>
<li><p>一个好的测试不应该在程序仅仅只是做了微小变化就失败</p>
</li>
<li><p>一个好的测试不应该在遇到一点小错误时就立刻退出测试，它应该尝试报告更多的相关的错误信息，因为我们可能从多个失败测试的模式中发现错误产生的规律</p>
</li>
<li><p>一个好的测试的关键是首先实现你期望的具体行为，然后才是考虑简化测试代码、避免重复。如果直接从抽象、通用的测试库着手，很难取得良好结果。</p>
</li>
<li><p>保持测试代码的简洁和内部结构的稳定，特别是对断言部分要有所选择，比如不要对字符串进行全字匹配，而是针对那些在项目的发展中是比较稳定不变的子串</p>
</li>
<li><p>测试时涉及到对全局变量产生修改的那些测试，要以串行的方式运行，不能并行运行</p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/golang-test-benchmark-timer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
      <meta itemprop="description" content="后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/golang-test-benchmark-timer/" class="post-title-link" itemprop="url">go 语言 性能测试函数中的计时器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-19 23:41:47" itemprop="dateCreated datePublished" datetime="2021-07-19T23:41:47+00:00">2021-07-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/golang/" itemprop="url" rel="index"><span itemprop="name">golang</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="计时器"><a href="#计时器" class="headerlink" title="计时器"></a>计时器</h1><p>用来记录性能测试函数在每次运行时消耗的时间，同时它也记录了此次运行对内存分配的字节数和分配的次数。与之相关的有三个方法<code>StartTimer</code>、<code>StopTimer</code>和<code>ResetTimer</code></p>
<p>运行go test 时就用到了计时器，命令会启用这个函数的计时器，当函数执行完成，停止计时器，记录下此次的运行时间，然后与默认执行时间上限(默认为1秒)做比较，如果没有超过，则增大<code>b.N</code>的值，再次执行该函数，如此反复，直到函数的运行时间大于或等于执行时间上限，从而得到<code>b.N</code>的值，即函数的最大执行次数及对应的时间，从而得出最终的测试结果</p>
<p>通过对 StartTimer、StopTimer的调用，我们可以在测试中去除那些本不应该计入测试时间的代码的执行时间，比如一些测试前的准备代码</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">BenchmarkGetPrimes</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	b<span class="token punctuation">.</span><span class="token function">StopTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 模拟某个耗时但与被测程序关系不大的操作</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">500</span><span class="token punctuation">)</span>
	max <span class="token operator">:=</span> <span class="token number">10000</span>
	b<span class="token punctuation">.</span><span class="token function">StartTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token function">GetPrimes</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>time.Sleep</code>用来模拟得到<code>max</code>的值所要进行的耗时操作，而我们要测试的是<code>GetPrimes()</code>的性能，不应计入计算<code>max</code>值所用的时间，所以要把开始时间设置在得到<code>max</code>之后。</p>
<p>通过 <code>b.StopTimer()</code> 与 <code>b.StartTimer()</code>的配合使用，就可以去除任何一段代码的执行时间，<code>b.ResetTimer()</code>是去除它之前代码的执行时间。通过对计时器的调用，可以让测试函数的执行时间更加准确。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/github-actions-workflows-hexo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
      <meta itemprop="description" content="后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/github-actions-workflows-hexo/" class="post-title-link" itemprop="url">GitHub Actions Workflows 部署 Hexo</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-14 15:04:55" itemprop="dateCreated datePublished" datetime="2021-07-14T15:04:55+00:00">2021-07-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/ci/" itemprop="url" rel="index"><span itemprop="name">ci</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Github-Action"><a href="#Github-Action" class="headerlink" title="Github Action"></a>Github Action</h1><p>是Github 提供的免费可持续集成服务，在 GitHub Actions 的仓库中自动化、自定义和执行软件开发工作流程。 可以发现、创建和共享操作以执行任何作业（包括 CI/CD），并将操作合并到完全自定义的工作流程中。</p>
<p>GitHub Actions 简单易用，在仓库根目录下建立<code>.github/workflows</code>文件夹，把workflows工作流文件(<code>YAML</code>)放到这个目录下，就可以使用Github Action服务了</p>
<h1 id="workflows-文件"><a href="#workflows-文件" class="headerlink" title="workflows 文件"></a>workflows 文件</h1><p>由多个job组合而成，其指定了持续集成要完成的工作，每个工作流文件代表着一个持续集成工程</p>
<ul>
<li>每个<code>workflow</code>由多个<code>job</code>组成，每个<code>job</code>就是你指定的任务</li>
<li>每个<code>job</code>由多个<code>step</code>组成，每个<code>step</code>代表任务的具体步骤</li>
<li>每个<code>step</code>由多个<code>action</code>组成，代表具体要执行的指令，<code>actoin</code> 是<code>workflows</code>中的最小单位</li>
</ul>
<p><img src="//img.gagahappy.cn/blog/2021/07/github-actions-workflows-hexo.jpg_b1" alt="GitHub Actions Workflows" title="GitHub Actions Workflows"></p>
<h1 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h1><p>GitHub提供了大量方便的工具，使你可以轻松的完成各种任务。比如克隆仓库并检出，向仓库提交内容，安装各种语言环境，同步文件等等，都有对应的工具，它们就是 Action，只需要调用它们就可以了，几乎不用写任何命令，你需要的在<a target="_blank" rel="noopener" href="https://github.com/marketplace?type=actions">Action市场</a>几乎全部可以找到。如<code> actions/checkout</code>是用来checout仓库的，<code>actions</code>表示这个工具是官方的，如果是其它名称，则表示是第三方提供的</p>
<h1 id="Hexo-发布到-Github-Pages-及-Ailyun"><a href="#Hexo-发布到-Github-Pages-及-Ailyun" class="headerlink" title="Hexo 发布到  Github Pages  及  Ailyun"></a>Hexo 发布到  Github Pages  及  Ailyun</h1><p>没有使用 GitHub Actions 的发布流程</p>
<ol>
<li><code>push</code></li>
<li>生成静态页：Hexo或hugo，Jekyll等静态博客生成器</li>
<li><code>push</code>静态页，在 <code>github pages</code>上完成发布</li>
<li>登录远程服务器，拉取静态页，在自己的站点完成发布</li>
</ol>
<p>使用 GitHub Actions 的发布流程</p>
<ol>
<li><code>push</code></li>
</ol>
<p>后面的工作完全自动化完成</p>
<ul>
<li>你不需要在你的本机上安装Hexo等静态站点生成器运行环境</li>
<li>文章的Build的工作在GitHub 的 <code>work runner</code>中完成，不需要占用的你电脑的资源</li>
<li>在GitHub 上构建速度快，软硬件兼容性问题也少</li>
<li>可以随时随地的部署：比如你发布后发现有个错别字要改，那么你用手机登录Github，直接在页面上修改，提交后就会触发部署，甚至都不需要打开电脑，方便快捷。</li>
</ul>
<h2 id="建立SSH密钥对"><a href="#建立SSH密钥对" class="headerlink" title="建立SSH密钥对"></a>建立SSH密钥对</h2><p>博客涉及到三个仓库：</p>
<ul>
<li>Hexo.git，用来存放Hexo项目和文章</li>
<li>next.git博客主题</li>
<li>gagahappy.github.io 用来存放发布的HTML页，设置为 Github Pages</li>
</ul>
<p>为什么会用到密钥对</p>
<ul>
<li><p>Aliyun服务器：构建过程中要远程登录到Aliyun服务器，要用密钥进行身份验证，需要用到密钥对</p>
</li>
<li><p>Github Pages：Github的建议是把源文件即Hexo.git放到master分支，把gagahappy.github.io放到gh-pages分支。但Github Pages必须是公开仓库才可以发布，这样就让存放源文件的Hexo.git也可以被访问，这显然是不安全的，所以没有把这两个仓库放在一起，那么对gagahappy.github.io进行发布就需要使用密钥对，才能对仓库进行操作。如果你遵循了Github的建议，那这么在发布Github pages时就不用设置密钥对了。</p>
</li>
</ul>
<p>生成密钥对</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ssh-keygen -t rsa -b <span class="token number">4096</span> -C <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">git</span> config user.email<span class="token variable">)</span></span>"</span> -f gh-pages -N <span class="token string">""</span>
<span class="token comment"># You will get 2 files:</span>
<span class="token comment">#   gh-pages.pub (public key)</span>
<span class="token comment">#   gh-pages     (private key)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>把<code>gh-pages.pub</code>中的内容添加到远程服务器的<code>~/.ssh/authorized_keys</code>中或把文件上传到<code>~/.ssh/</code>目录，执行</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> gh-pages.pub <span class="token operator">>></span> authorized_keys
<span class="token function">chmod</span> <span class="token number">600</span> -R ~/.ssh <span class="token comment"># 设置~/ssh目录权限</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h2 id="设置-github-Secrets"><a href="#设置-github-Secrets" class="headerlink" title="设置 github Secrets"></a>设置 github Secrets</h2><p>Secrets 是用来存放敏感信息的，如数据库的密码，用户名，密钥，等信息，不会让这些信息在日志输出中暴露出来，会以星号(*)代替这些敏感信息。</p>
<p>在Hexo.git仓库的首页点击 <code>settings</code>，在左侧找到<code>Secrets</code>，点击右上<code>New repository secret </code>，<code>name</code>填写<code>ACTIONS_DEPLOY_KEY</code> ，<code>value</code>填写密钥<code>gh-pages</code>的内容， 点击<code>Add secret</code>，这样就创建了一个<code>secret</code>。之后可以用这个<code>secret</code>操作 gagahappy.github.io 仓库。</p>
<p>你还可以创建其它的<code>secret</code>，比如MySQL连接的密码，可以新建一个名称为<code>mysql_passwd</code>，内容为MySQL密码的<code>Secret</code>。更多信息可以查看官方 <a target="_blank" rel="noopener" href="https://docs.github.com/en/actions/reference/encrypted-secrets">Secrets 帮助</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># secret 在日志中使用 * 号输出敏感信息</span>
SOURCE: public/
REMOTE_HOST: ***
REMOTE_USER: ***
TARGET: ***
SSH_PRIVATE_KEY: ***<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="设置-Deploy-keys"><a href="#设置-Deploy-keys" class="headerlink" title="设置 Deploy keys"></a>设置 Deploy keys</h2><p>打开<code>gagahappy.github.io</code>仓库，在仓库的首页点击 <code>settings</code>，在左侧找到<code>Deploy keys</code>，把<code>gh-pages.pub</code>的内容复制进去，勾选下面的<code>Allow write access</code>，点击<code>Add Key</code>，这样在之后的部署过程中，Hexo.git仓库所在的<code>runner</code>就可以通过<code>secrets.ACTIONS_DEPLOY_KEY</code>对其进行操作了。</p>
<h2 id="编写工作流文件"><a href="#编写工作流文件" class="headerlink" title="编写工作流文件"></a>编写工作流文件</h2><p>在Hexo.git项目根目录下建立<code>.github/wrokflows</code>文件夹，在这个文件夹下创建以<code>yml</code>结尾的文件<code>build.yml</code>。每当你<code>push</code>到github后，github会自动寻找仓库根目录下的<code>.github/wrokflows</code>中扩展名为<code>yml</code>的所文件，运行其中的指令，完成自动部署。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> -p .github/workflows
<span class="token function">touch</span> .github/workflows/build.yml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>需要持续集成完成的工作有</p>
<ol>
<li>Checkout <code>hexo.git</code>中的内容</li>
<li>Checkout <code>next.git</code>主题内容到 theme目录</li>
<li>安装 <code>node.js</code>环境</li>
<li>安装Hexo</li>
<li>使用Hexo生成静态页面</li>
<li>发布静态页面到 <code>gagahappy.github.io</code></li>
<li>同步静态页到Aliyun服务器</li>
</ol>
<p>把以上内容翻译为要执行的配置命令就是</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>master<span class="token punctuation">]</span> <span class="token comment"># 在master分支push时触发部署</span>
    <span class="token key atrule">paths-ignore</span><span class="token punctuation">:</span> <span class="token comment"># 以下文件的变更不触发部署</span>
      <span class="token punctuation">-</span> README.md
  <span class="token key atrule">workflow_dispatch</span><span class="token punctuation">:</span>

<span class="token key atrule">env</span><span class="token punctuation">:</span> <span class="token comment"># 统一设置环境变量</span>
  <span class="token key atrule">GIT_USER</span><span class="token punctuation">:</span> git
  <span class="token key atrule">GIT_EMAIL</span><span class="token punctuation">:</span> email@example.com
  <span class="token key atrule">THEME_REPO</span><span class="token punctuation">:</span> git/next <span class="token comment"># 你使用的主题仓库地址</span>
  <span class="token key atrule">THEME_BRANCH</span><span class="token punctuation">:</span> master
  <span class="token key atrule">DEPLOY_REPO</span><span class="token punctuation">:</span> git/gagahappy.github.io <span class="token comment"># 你用来发布github pages的仓库地址</span>
  <span class="token key atrule">DEPLOY_BRANCH</span><span class="token punctuation">:</span> master

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">build</span><span class="token punctuation">:</span> <span class="token comment"># job_id，其它job可以引用，比如两个job有先后顺序</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> Build Github Page And Deploy On Aliyun <span class="token comment"># job名称</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest <span class="token comment"># 构建使用的系统，支持 linux/mac/windows</span>
    <span class="token key atrule">timeout-minutes</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment"># job超时时间，超过后job会被停止运行</span>

    <span class="token key atrule">steps</span><span class="token punctuation">:</span> <span class="token comment"># 一个job由多个 step 组成，本博的由7个step组成</span>
    	<span class="token comment"># 1. Checkout hexo.git 中的内容</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout Hexo repo
      	<span class="token comment"># 检出项目，如果不指定名称，默认使用运行Github Action 的仓库，即hexo.git</span>
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2

    	<span class="token comment"># 2. Checkout next.git 主题内容到 theme目录</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout Theme repo
      	<span class="token comment"># actions/checkout 就是Acton工具，实现checkout项目，每个action也是一个git仓库</span>
      	<span class="token comment"># 可以直接通过 github.com/工具名称进行访问，即github.com/actions/checkout</span>
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">repository</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.THEME_REPO <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span class="token comment"># 要checkout的仓库地址</span>
          <span class="token key atrule">ref</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.THEME_BRANCH <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> themes/next <span class="token comment"># 要checkout到的路径</span>

    	<span class="token comment"># 3. 安装 node.js 环境</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Use Node.js $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> matrix.node <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v2 <span class="token comment"># 使用actions/setup-node安装nodejs</span>
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> matrix.node <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>

    	<span class="token comment"># 4. 安装Heox</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install Hexo
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span> <span class="token comment"># 运行command命令</span>
          npm install <span class="token punctuation">-</span>g hexo<span class="token punctuation">-</span>cli
          npm install

    	<span class="token comment"># 5. 使用Hexo生成静态页面</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Generate Blog
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          hexo generate</span>

    	<span class="token comment"># 6. 发布静态页面到 gagahappy.github.io</span>
			<span class="token comment"># 使用 peaceiris/actions-gh-pages 第三方Action工具，发布静态内容到 github pages</span>
			<span class="token comment"># 重要:</span>
			<span class="token comment"># 如果你的源码文件与Html文件在两个仓库，请在源码文件仓库设置</span>
			<span class="token comment"># secrets 的 ACTIONS_DEPLOY_KEY 值为密钥内容，</span>
			<span class="token comment"># 在html文件仓库即youname.github.io中设置 Deploy keys 的值设置为公钥内容，</span>
			<span class="token comment"># 在构建过程中会使用密钥对youname.github.io进行操作</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy Github Page
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> peaceiris/actions<span class="token punctuation">-</span>gh<span class="token punctuation">-</span>pages@v3
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token comment"># 在 hexo.git 上设置的私钥</span>
          <span class="token key atrule">deploy_key</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> secrets.ACTIONS_DEPLOY_KEY <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span class="token comment"># ACTIONS_DEPLOY_KEY 不能修改</span>
          <span class="token key atrule">external_repository</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.DEPLOY_REPO <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span class="token comment"># Hexo.git 的仓库地址</span>
          <span class="token key atrule">publish_branch</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.DEPLOY_BRANCH <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
          <span class="token key atrule">publish_dir</span><span class="token punctuation">:</span> ./public <span class="token comment"># 使用Hexo/hugo等生成静态页面的目录</span>
          <span class="token key atrule">user_name</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.GIT_USER <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
          <span class="token key atrule">user_email</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.GIT_EMAIL <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>

    	<span class="token comment"># 7. 同步静态页到Aliyun服务器</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy Github Page on Aliyun
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> easingthemes/ssh<span class="token punctuation">-</span>deploy@main
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token key atrule">SSH_PRIVATE_KEY</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> secrets.ACTIONS_DEPLOY_KEY <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">ARGS</span><span class="token punctuation">:</span> <span class="token string">"-rltgoDzvO --delete"</span>
            <span class="token key atrule">SOURCE</span><span class="token punctuation">:</span> <span class="token string">"public/"</span> <span class="token comment"># 使用Hexo/hugo等生成静态页面的目录</span>
            <span class="token key atrule">REMOTE_HOST</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> secrets.REMOTE_HOST <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">REMOTE_USER</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> secrets.REMOTE_USER <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">TARGET</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> secrets.REMOTE_TARGET <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>可以点击仓库主页上的<code>Actions</code>，查看正在运行的<code>workflows</code>，里面有详细的日志信息</p>
<p><img src="//img.gagahappy.cn/blog/2021/07/github-actions-workflows-hexo-2.png_b1" alt="GitHub Actions Workflows" title="GitHub Actions Workflows"></p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><ul>
<li>GitHub <a target="_blank" rel="noopener" href="https://github.com/marketplace?type=actions">官方市场</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/actions">https://github.com/actions</a></li>
<li>Action <a target="_blank" rel="noopener" href="https://github.com/sdras/awesome-actions">awesome actions</a> 仓库</li>
<li><a target="_blank" rel="noopener" href="https://help.github.com/en/articles/about-actions">https://help.github.com/en/articles/about-actions</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions">https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/peaceiris/actions-gh-pages">https://github.com/peaceiris/actions-gh-pages</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.github.com/en/actions/reference/encrypted-secrets">https://docs.github.com/en/actions/reference/encrypted-secrets</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.github.com/cn/actions">https://docs.github.com/cn/actions</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/golang-test-flag-cpu-count-parallel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
      <meta itemprop="description" content="后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/golang-test-flag-cpu-count-parallel/" class="post-title-link" itemprop="url">go 语言 test 测试工具的标记 flag</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-11 17:16:54" itemprop="dateCreated datePublished" datetime="2021-07-11T17:16:54+00:00">2021-07-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/golang/" itemprop="url" rel="index"><span itemprop="name">golang</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="cpu-标记"><a href="#cpu-标记" class="headerlink" title="cpu 标记"></a>cpu 标记</h1><p>用来设置运行时，P的最大数量，即<code>GOMAXPROCS</code>的值。可以设置一组值，在运行测试时，P被设置为不同的值分别运行测试函数。</p>
<p>最大P数量代表着 go 运行时系统同时运行goroutine的能力，可以被视为最大逻辑CPU的数量，在默认情况下，最大 P 数量就等于当前计算机 CPU 核心的实际数量，最大P可以大于或小于实际CPU的核心数量。</p>
<p>通过设置<code>-cpu</code>的值，就可以来模拟程序在不同CPU数量下的表现。设置<code>-cpu=2,4,8</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> -cpu<span class="token operator">=</span><span class="token number">2,4</span>,8 -bench<span class="token operator">=</span>. gott/hello
goos: darwin
goarch: amd64
pkg: gott/hello
BenchmarkHello-2         <span class="token number">5081475</span>               <span class="token number">228.6</span> ns/op
BenchmarkHello-4         <span class="token number">5190867</span>               <span class="token number">215.8</span> ns/op
BenchmarkHello-8         <span class="token number">5256798</span>               <span class="token number">212.6</span> ns/op
PASS
ok      gott/hello      <span class="token number">4</span>.129s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>性能测试函数<code>BenchmarkHello</code>被执行了3次，最大P数量分别为<code>2,4,8</code></p>
<p>如果没有指定<code>-cpu</code>参数，测试运行时使用默认的最大P的数量，这个数量就等于当前CPU实际的核心数(比如你的CPU是4核，那么这个数量就是4)</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> -bench<span class="token operator">=</span>.  gott/hello
goos: darwin
goarch: amd64
pkg: gott/hello
BenchmarkHello-4         <span class="token number">4670545</span>               <span class="token number">234.7</span> ns/op
PASS
ok      gott/hello      <span class="token number">1</span>.381s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>BenchmarkHello-4 </code>表明默认P的值为4，即cpu是4核</p>
<h1 id="count-标记"><a href="#count-标记" class="headerlink" title="count 标记"></a>count 标记</h1><p>设置重复执行测试函数的次数</p>
<p>性能函数总的执行次数=<code>-cpu</code>标记的值中正整数的个数 x <code>-count</code>标记的值 x 探索式执行中测试函数的实际执行次数=2 * 2 * 5 =20</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> -count<span class="token operator">=</span><span class="token number">2</span> -bench<span class="token operator">=</span>. -cpu<span class="token operator">=</span><span class="token number">2,4</span>  gott/hello
goos: darwin
goarch: amd64
pkg: gott/hello
BenchmarkHello-2         <span class="token number">5184015</span>               <span class="token number">224.1</span> ns/op
--- BENCH: BenchmarkHello-2
    hello_test.go:30: NNNNN: <span class="token number">1</span>
    hello_test.go:30: NNNNN: <span class="token number">100</span>
    hello_test.go:30: NNNNN: <span class="token number">10000</span>
    hello_test.go:30: NNNNN: <span class="token number">1000000</span>
    hello_test.go:30: NNNNN: <span class="token number">5184015</span>
BenchmarkHello-2         <span class="token number">5676196</span>               <span class="token number">214.5</span> ns/op
--- BENCH: BenchmarkHello-2
    hello_test.go:30: NNNNN: <span class="token number">1</span>
    hello_test.go:30: NNNNN: <span class="token number">100</span>
    hello_test.go:30: NNNNN: <span class="token number">10000</span>
    hello_test.go:30: NNNNN: <span class="token number">1000000</span>
    hello_test.go:30: NNNNN: <span class="token number">4618954</span>
    hello_test.go:30: NNNNN: <span class="token number">5676196</span>
BenchmarkHello-4         <span class="token number">5304111</span>               <span class="token number">213.8</span> ns/op
--- BENCH: BenchmarkHello-4
    hello_test.go:30: NNNNN: <span class="token number">1</span>
    hello_test.go:30: NNNNN: <span class="token number">100</span>
    hello_test.go:30: NNNNN: <span class="token number">10000</span>
    hello_test.go:30: NNNNN: <span class="token number">1000000</span>
    hello_test.go:30: NNNNN: <span class="token number">5304111</span>
BenchmarkHello-4         <span class="token number">5286376</span>               <span class="token number">212.4</span> ns/op
--- BENCH: BenchmarkHello-4
    hello_test.go:30: NNNNN: <span class="token number">1</span>
    hello_test.go:30: NNNNN: <span class="token number">100</span>
    hello_test.go:30: NNNNN: <span class="token number">10000</span>
    hello_test.go:30: NNNNN: <span class="token number">1000000</span>
    hello_test.go:30: NNNNN: <span class="token number">5286376</span>
PASS
ok      gott/hello      <span class="token number">6</span>.601s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>功能函数总的执行次数=<code>-cpu</code>标记的值中正整数的个数 x <code>-count</code>标记的值=3 x 2 = 6</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> -v -count<span class="token operator">=</span><span class="token number">2</span>  -cpu<span class="token operator">=</span><span class="token number">2,4</span>,8  gott/hello
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestHello
    hello_test.go:17: number of runtime.GOMAXPROCS: <span class="token number">2</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestHello
    hello_test.go:17: number of runtime.GOMAXPROCS: <span class="token number">2</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestHello
    hello_test.go:17: number of runtime.GOMAXPROCS: <span class="token number">4</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestHello
    hello_test.go:17: number of runtime.GOMAXPROCS: <span class="token number">4</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestHello
    hello_test.go:17: number of runtime.GOMAXPROCS: <span class="token number">8</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestHello
    hello_test.go:17: number of runtime.GOMAXPROCS: <span class="token number">8</span>
ok      gott/hello      <span class="token number">0</span>.009s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对于功能测试，并不需要重复的执行多次，只需要执行一次即可，所以可以把<code>-cpu</code>的数值设置为1，<code>-count</code>的值不用设置，使用默认值为1就可以。功能测试关注的重点是验证逻辑是否正确，而不是程序的性能</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> -v   -cpu<span class="token operator">=</span><span class="token number">1</span> gott/hello
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestHello
    hello_test.go:17: number of runtime.GOMAXPROCS: <span class="token number">1</span>
--- PASS: TestHello <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      gott/hello      <span class="token number">0</span>.008s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="Parallel-标记"><a href="#Parallel-标记" class="headerlink" title="Parallel 标记"></a>Parallel 标记</h1><p><code>-parallel</code>标记可以指定同时运行测试用例的最大并发执行数，但仅适用于单个二进制测试文件，通过修改<code>GOMAXPROCS</code>的值实现，该标记的默认值是测试运行时的最大 P 数量。</p>
<p>可以通过在测试函数中添加<code>t.Parallel()</code>调用，以同时运行多个功能测试。默认情况下 go test 在运行测试时，为了加快测试速度，package 是被并行运行的，但每个包中的功能测试用例是被串行执行的。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TestParallelPrintHello</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	t<span class="token punctuation">.</span><span class="token function">Parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">200</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"==========Hello=========="</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">TestParallelPrintWorld</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	t<span class="token punctuation">.</span><span class="token function">Parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"number of runtime.GOMAXPROCS:"</span><span class="token punctuation">,</span> runtime<span class="token punctuation">.</span><span class="token function">GOMAXPROCS</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">200</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"==========World=========="</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>使用<code>t.Parallel()</code>指定需要并行执行的测试，在测试结果中可以看到TestParallelPrintWorld与TestParallelPrintHello交替输出，说明这两个测试函数是并行执行的</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> -v -parallel<span class="token operator">=</span><span class="token number">8</span> gott/hello
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestParallelPrintHello
<span class="token operator">==</span><span class="token operator">=</span> PAUSE TestParallelPrintHello
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestParallelPrintWorld
<span class="token operator">==</span><span class="token operator">=</span> PAUSE TestParallelPrintWorld
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintHello
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintWorld
    hello_test.go:43: number of runtime.GOMAXPROCS: <span class="token number">4</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintHello
    hello_test.go:36: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Hello<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintWorld
    hello_test.go:46: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>World<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
    hello_test.go:46: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>World<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintHello
    hello_test.go:36: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Hello<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
    hello_test.go:36: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Hello<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintWorld
    hello_test.go:46: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>World<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
    hello_test.go:46: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>World<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintHello
    hello_test.go:36: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Hello<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintWorld
    hello_test.go:46: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>World<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintHello
    hello_test.go:36: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Hello<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
--- PASS: TestParallelPrintWorld <span class="token punctuation">(</span><span class="token number">1</span>.02s<span class="token punctuation">)</span>
--- PASS: TestParallelPrintHello <span class="token punctuation">(</span><span class="token number">1</span>.02s<span class="token punctuation">)</span>
PASS
ok      gott/hello      <span class="token number">1</span>.026s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>测试结果中<code>runtime.GOMAXPROCS: 4  </code>的值为4，并不是指定的<code>8</code>，说明<code>-parallel</code>标记并没有生成，因为测试运行的不是二进制文件，此时，即使不指定<code>-parallel</code>也是可以的，如果想让更多的测试用例同时运行，可以在运行<code>go test</code>时，指定<code>-p</code>参数，运行更多的P，来同时执行更多的测试用例，比如设置p的值为4，让同时并行执行的最大并发数为4</li>
<li>使用<code>t.Parallel()</code>后，输出的信息多了<code>PAUSE</code>和<code>CONT</code>字段</li>
</ul>
<p>如果加入<code>-count=2</code>标记，对于测试用例来说，此时的并发不会是2个count之间的并发，这两个count也是串行执行的</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> -v -count<span class="token operator">=</span><span class="token number">2</span>  gott/hello
<span class="token comment"># 这里是第一遍count</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestParallelPrintHello
<span class="token operator">==</span><span class="token operator">=</span> PAUSE TestParallelPrintHello
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestParallelPrintWorld
<span class="token operator">==</span><span class="token operator">=</span> PAUSE TestParallelPrintWorld
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintHello
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintWorld
    hello_test.go:43: number of runtime.GOMAXPROCS: <span class="token number">4</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintHello
    hello_test.go:36: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Hello<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintWorld
    hello_test.go:46: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>World<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintHello
    hello_test.go:36: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Hello<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintWorld
    hello_test.go:46: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>World<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintHello
    hello_test.go:36: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Hello<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintWorld
    hello_test.go:46: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>World<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintHello
    hello_test.go:36: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Hello<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintWorld
    hello_test.go:46: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>World<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
    hello_test.go:46: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>World<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
--- PASS: TestParallelPrintWorld <span class="token punctuation">(</span><span class="token number">1</span>.02s<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintHello
    hello_test.go:36: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Hello<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
--- PASS: TestParallelPrintHello <span class="token punctuation">(</span><span class="token number">1</span>.02s<span class="token punctuation">)</span>

<span class="token comment"># 这里是第二遍count</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestParallelPrintHello
<span class="token operator">==</span><span class="token operator">=</span> PAUSE TestParallelPrintHello
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestParallelPrintWorld
<span class="token operator">==</span><span class="token operator">=</span> PAUSE TestParallelPrintWorld
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintHello
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintWorld
    hello_test.go:43: number of runtime.GOMAXPROCS: <span class="token number">4</span>
    hello_test.go:46: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>World<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintHello
    hello_test.go:36: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Hello<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
    hello_test.go:36: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Hello<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintWorld
    hello_test.go:46: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>World<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
    hello_test.go:46: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>World<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintHello
    hello_test.go:36: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Hello<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
    hello_test.go:36: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Hello<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintWorld
    hello_test.go:46: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>World<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
    hello_test.go:46: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>World<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestParallelPrintHello
    hello_test.go:36: <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Hello<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
--- PASS: TestParallelPrintWorld <span class="token punctuation">(</span><span class="token number">1</span>.01s<span class="token punctuation">)</span>
--- PASS: TestParallelPrintHello <span class="token punctuation">(</span><span class="token number">1</span>.01s<span class="token punctuation">)</span>
PASS
ok      gott/hello      <span class="token number">2</span>.036s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h1 id="源码文件"><a href="#源码文件" class="headerlink" title="源码文件"></a>源码文件</h1><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// hello.go</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">hello</span><span class="token punctuation">(</span><span class="token string">"max"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">hello</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprint</span><span class="token punctuation">(</span><span class="token string">"hello "</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// hello_test.go</span>
<span class="token keyword">func</span> <span class="token function">TestHello</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	name <span class="token operator">:=</span> <span class="token string">"Max"</span>
	expected <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"hello %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
	greeting <span class="token operator">:=</span> <span class="token function">hello</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
	<span class="token keyword">if</span> greeting <span class="token operator">!=</span> expected <span class="token punctuation">&#123;</span>
		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"hello(%s) = %s, expected = %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> greeting<span class="token punctuation">,</span> expected<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>expected<span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"number of runtime.GOMAXPROCS:"</span><span class="token punctuation">,</span> runtime<span class="token punctuation">.</span><span class="token function">GOMAXPROCS</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">TestPrint</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"just Print"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkHello</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token function">hello</span><span class="token punctuation">(</span><span class="token string">"Max"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	b<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"NNNNN:"</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>N<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">TestParallelPrintHello</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	t<span class="token punctuation">.</span><span class="token function">Parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">200</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"==========Hello=========="</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">TestParallelPrintWorld</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	t<span class="token punctuation">.</span><span class="token function">Parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"number of runtime.GOMAXPROCS:"</span><span class="token punctuation">,</span> runtime<span class="token punctuation">.</span><span class="token function">GOMAXPROCS</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">200</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"==========World=========="</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><ul>
<li>可以通过运行<code>runtime.GOMAXPROCS(0)</code>获得运行时的最大P的数量</li>
<li>在功能测试中，无法避免依赖一些外部环境，比如数据库的连接，第三方接口的调用，应该对这些外部环境进行仿造(mock)，从而得到一个纯净的测试环境</li>
<li><code>go help testflag  </code>查看 flag 帮助文件</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/golang-test-benchmark-result-introducing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
      <meta itemprop="description" content="后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/golang-test-benchmark-result-introducing/" class="post-title-link" itemprop="url">go 语言 基准测试 结果解读</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-08 15:16:54" itemprop="dateCreated datePublished" datetime="2021-07-08T15:16:54+00:00">2021-07-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/golang/" itemprop="url" rel="index"><span itemprop="name">golang</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="基准测试"><a href="#基准测试" class="headerlink" title="基准测试"></a>基准测试</h1><p>是测量一个程序在固定工作负载下的性能，使用 <code>-bench</code> 标记可以对代码进行基准测试</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> test <span class="token operator">-</span>v <span class="token operator">-</span>bench<span class="token operator">=</span><span class="token punctuation">.</span> <span class="token operator">-</span>run<span class="token operator">=</span><span class="token operator">^</span>$ gott<span class="token operator">/</span>hello
goos<span class="token punctuation">:</span> darwin
goarch<span class="token punctuation">:</span> amd64
pkg<span class="token punctuation">:</span> gott<span class="token operator">/</span>hello
BenchmarkHello<span class="token operator">-</span><span class="token number">4</span>         <span class="token number">4964053</span>               <span class="token number">228.5</span> ns<span class="token operator">/</span>op
PASS
ok      gott<span class="token operator">/</span>hello      <span class="token number">2.386</span>s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p><code>.</code>表示执行代码包中所有的基准测试用例(前缀为<code>Benchmark</code>的方法)，由于功能测试也会被运行，但同时运行功能测试会影响性能测试的结果，通过加入<code>-run=^$</code>，来禁止功能测试与性能测试一起执行。<code>^$</code>意味着：只执行名称为空的功能测试函数，即不执行任何测试函数。</p>
</li>
<li><p>指定运行某个基准测试</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> test <span class="token operator">-</span>v <span class="token operator">-</span>bench<span class="token operator">=</span>BenchmarkHello gott<span class="token operator">/</span>hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>功能测试也会一起运行。。。。。。</p>
</li>
</ul>
<h1 id="b-N值的确定"><a href="#b-N值的确定" class="headerlink" title="b.N值的确定"></a><code>b.N</code>值的确定</h1><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">BenchmarkHello</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token function">hello</span><span class="token punctuation">(</span><span class="token string">"Max"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>当测试开始时，<code>b.N</code>的值被设置为1，执行后如果没有超过默认执行时间上限(默认为1秒)，则加大<code>b.N</code>的值，按某种规则一直递增，直到执行时间等于或超过上限，那么就用这一次的<code>b.N</code>的值，做为测试的最终结果</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">BenchmarkHello<span class="token operator">-</span><span class="token number">4</span>         <span class="token number">4964053</span>               <span class="token number">228.5</span> ns<span class="token operator">/</span>op
PASS
ok      gott<span class="token operator">/</span>hello      <span class="token number">2.386</span>s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>BenchmarkHello-4</code>表示执行 BenchmarkHello 时，所用的最大P的数量为4</li>
<li><code>4964053</code>:  表示<code>hello()</code>方法在达到这个执行次数时，等于或超过了1秒</li>
<li><code>228.5 ns/op</code>： 表示每次执行<code>hello()</code>所消耗的平均执行时间</li>
<li><code>2.386s</code>：表示测试总共用时</li>
</ul>
<h1 id="测试总时间的计算"><a href="#测试总时间的计算" class="headerlink" title="测试总时间的计算"></a>测试总时间的计算</h1><p>既然<code>4964053</code>表示1秒或大于1秒时执行的次数，那么测试总时间用时却是<code>2.386s</code>，超出了不少，这是为什么呢</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">BenchmarkHello</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token function">hello</span><span class="token punctuation">(</span><span class="token string">"Max"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	b<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"NNNNN:"</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>N<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在测试中加入<code>b.Log(&quot;NNNNN:&quot;, b.N)</code>，再执行基准测试，并加入<code>-v</code>，打印测试中的日志</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> -v -bench<span class="token operator">=</span>. -run<span class="token operator">=</span>^$ gott/hello
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestHello
    hello_test.go:15: hello Max
--- PASS: TestHello <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestPrint
    hello_test.go:19: just Print
--- PASS: TestPrint <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
goos: darwin
goarch: amd64
pkg: gott/hello
BenchmarkHello
    hello_test.go:26: NNNNN: <span class="token number">1</span>
    hello_test.go:26: NNNNN: <span class="token number">100</span>
    hello_test.go:26: NNNNN: <span class="token number">10000</span>
    hello_test.go:26: NNNNN: <span class="token number">1000000</span>
    hello_test.go:26: NNNNN: <span class="token number">3541896</span>
    hello_test.go:26: NNNNN: <span class="token number">4832275</span>
BenchmarkHello-4         <span class="token number">4832275</span>               <span class="token number">236.8</span> ns/op
PASS
ok      gott/hello      <span class="token number">2</span>.395s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到<code>b.Log(&quot;NNNNN:&quot;, b.N)</code>被执行了6次，这证明了之前提到的，测试会对<code>b.N</code>依次递增，直到执行时间等于或超过上限。在对<code>BenchmarkHello()</code>运行基准测试时，N值依次按<code>1,100,10000,1000000,3541896,4832275</code>递增，直到执行次数为<code>4832275</code>时，执行时间等于或超过了上限。</p>
<p>同时也说明<code>BenchmarkHello()</code>一共被调用了6次，每次运行<code>BenchmarkHello()</code>都要消耗一定的时间，所以测试总耗时为这6次调用时间之和，<code>2.395s</code>，超过了1秒</p>
<h1 id="平均执行时间的计算"><a href="#平均执行时间的计算" class="headerlink" title="平均执行时间的计算"></a>平均执行时间的计算</h1><p>应该用，运行<code>4832275</code>时所消耗的时间 <code>t</code>，<code>t / 4832275 = 236.8 ns/op</code></p>
<ul>
<li>如果用 测试总共用时 / 最多可以执行的次数  则不等于 平均执行时间，即 <code>2.386 * (1000 ** 3) / 4832275 = 493.7 </code> 大于测试结果中的<code>236.8 ns/op</code>。</li>
<li>如果用 <code>1 秒 / 4832275 = 206 ns</code> ，与<code>236.8 ns/op</code>并不是很接近</li>
<li>如果把尝试过程中的运行次数也加入进来<code>total = 1 + 100 + 10000 + 1000000 + 3541896 + 4832275</code>，即<code>2.386 * (1000 ** 3) / 9384272 = 254.25</code>与<code>236.8 ns/op</code>接近</li>
<li>反推运行时间：<code>4832275 * 236.8 ns / 1000 ** 3 = 1.14s</code> ，测试结果使用了运行时间超过1秒上限时的数值</li>
</ul>
<p>问题：是否测试总时间一定会超过1秒？答：因为要找到最大可执行次数，而在这之前肯定要进行多次尝试，所以测试总时间应该总是会超过1秒的。</p>
<h1 id="benchtime-标记"><a href="#benchtime-标记" class="headerlink" title="benchtime 标记"></a>benchtime 标记</h1><p>可以通过<code> -benchtime</code>标记修改默认时间上限，比如改为3秒</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> -v -bench<span class="token operator">=</span>. -benchtime<span class="token operator">=</span>3s -run<span class="token operator">=</span>^$ gott/hello
goos: darwin
goarch: amd64
pkg: gott/hello
BenchmarkHello
    hello_test.go:31: NNNNN: <span class="token number">1</span>
    hello_test.go:32: /Users/ga/m/opt/go/go_root
    hello_test.go:31: NNNNN: <span class="token number">100</span>
    hello_test.go:32: /Users/ga/m/opt/go/go_root
    hello_test.go:31: NNNNN: <span class="token number">10000</span>
    hello_test.go:32: /Users/ga/m/opt/go/go_root
    hello_test.go:31: NNNNN: <span class="token number">1000000</span>
    hello_test.go:32: /Users/ga/m/opt/go/go_root
    hello_test.go:31: NNNNN: <span class="token number">15927812</span>
    hello_test.go:32: /Users/ga/m/opt/go/go_root
BenchmarkHello-4   	<span class="token number">15927812</span>	       <span class="token number">223.4</span> ns/op
PASS
ok  	gott/hello	<span class="token number">3</span>.802s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>还可以设置具体的探索次数最大值，格式为<code>-benchtime=Nx</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> gott/hello -run<span class="token operator">=</span>^$ -bench<span class="token operator">=</span>BenchmarkHello -benchtime<span class="token operator">=</span>50x
goos: darwin
goarch: amd64
pkg: gott/hello
BenchmarkHello-4              <span class="token number">50</span>              <span class="token number">2183</span> ns/op
--- BENCH: BenchmarkHello-4
    hello_test.go:35: NNNNN: <span class="token number">1</span>
    hello_test.go:36: /Users/ga/m/opt/go/go_root
    hello_test.go:35: NNNNN: <span class="token number">50</span>
    hello_test.go:36: /Users/ga/m/opt/go/go_root
PASS
ok      gott/hello      <span class="token number">0</span>.011s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>b.N</code>的值被设置为50，函数运行了50次</p>
<h1 id="benchmem-标记"><a href="#benchmem-标记" class="headerlink" title="benchmem 标记"></a>benchmem 标记</h1><p>可以通过<code>-benchmem</code>标记查看内存使用信息</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> gott/hello -run<span class="token operator">=</span>^$ -bench<span class="token operator">=</span>BenchmarkHello -benchmem
goos: darwin
goarch: amd64
pkg: gott/hello
BenchmarkHello-4         <span class="token number">5137456</span>               <span class="token number">223.1</span> ns/op            <span class="token number">32</span> B/op          <span class="token number">2</span> allocs/op
--- BENCH: BenchmarkHello-4
    hello_test.go:35: NNNNN: <span class="token number">1</span>
    hello_test.go:36: /Users/ga/m/opt/go/go_root
    hello_test.go:35: NNNNN: <span class="token number">100</span>
    hello_test.go:36: /Users/ga/m/opt/go/go_root
    hello_test.go:35: NNNNN: <span class="token number">10000</span>
    hello_test.go:36: /Users/ga/m/opt/go/go_root
    hello_test.go:35: NNNNN: <span class="token number">1000000</span>
    hello_test.go:36: /Users/ga/m/opt/go/go_root
    hello_test.go:35: NNNNN: <span class="token number">5137456</span>
    hello_test.go:36: /Users/ga/m/opt/go/go_root
        <span class="token punctuation">..</span>. <span class="token punctuation">[</span>output truncated<span class="token punctuation">]</span>
PASS
ok      gott/hello      <span class="token number">1</span>.399s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>32 B/op</code>：平均每次迭代内存分配的字节数</li>
<li><code>2 allocs/op</code>：平均每次迭代内存分配的次数</li>
</ul>
<p>平均每次迭代计算的依据应该使用的是 <code>b.N=5137456</code>迭代次数</p>
<h1 id="基准测试的用途"><a href="#基准测试的用途" class="headerlink" title="基准测试的用途"></a>基准测试的用途</h1><p>一般用于对比两个不同的操作所消耗的时间，如</p>
<ul>
<li><p>渐近增长函数的运行时间</p>
<p>一个函数需要1ms处理1,000个元素，处理10000或1百万将需要多少时间呢</p>
</li>
<li><p>I/O缓存该设置为多大</p>
<p>基准测试可以帮助我们选择在性能达标情况下所需的最小内存</p>
</li>
<li><p>确定哪种算法更好</p>
</li>
</ul>
<p>比较型的基准测试代码</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">benchmark</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">,</span> size <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">Benchmark10</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span>         <span class="token punctuation">&#123;</span> <span class="token function">benchmark</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">Benchmark100</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span> <span class="token function">benchmark</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">Benchmark1000</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span>       <span class="token punctuation">&#123;</span> <span class="token function">benchmark</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过参数<code>size</code>来控制输入的大小，而不是直接修改<code>b.N</code>的值，除非你只是想知道一个固定大小的迭代的耗时，否则基准测试的结果将毫无意义</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/golang-test-log-print/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
      <meta itemprop="description" content="后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/golang-test-log-print/" class="post-title-link" itemprop="url">go 语言 测试日志打印</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-05 15:37:07" itemprop="dateCreated datePublished" datetime="2021-07-05T15:37:07+00:00">2021-07-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/golang/" itemprop="url" rel="index"><span itemprop="name">golang</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="缓存目录"><a href="#缓存目录" class="headerlink" title="缓存目录"></a>缓存目录</h1><p>Go 总是会缓存程序构建的结果，以便在将来使用(可以加速构建速度)。当有任何变动时，缓存就会失效，构建过程会真正的被执行。被缓存的构建结果保存在<code>go env GOCACHE</code>目录中，为了防止目录中的数据越来越多，go会自动删除不经常使用的缓存文件。可以手动清除缓存结果，执行<code>go clean -cache</code>即可。</p>
<p><code>go test</code>命令也会把测试成功的结果缓存起来，如果测试代码和源代码没有改动，再次运行测试时，直接使用缓存的结果。当源码和测试代码有改动时，缓存结果就会失效，测试会被真正的运行。运行<code>go clean -testcache</code>可以删除测试的缓存结果，但不会删除构建结果缓存</p>
<h1 id="测试日志打印"><a href="#测试日志打印" class="headerlink" title="测试日志打印"></a>测试日志打印</h1><p>可以使用<code>t.Log</code>与<code>t.Logf</code>方法打印测试日志，这两个方法会在测试失败时，进行打印，在测试成功的时候，是不进行打印的。如果想在测试结果中看到所有的日志，可以使用<code>-v</code>参数</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TestIntroduce</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	intro <span class="token operator">:=</span> <span class="token function">introduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	expected <span class="token operator">:=</span> <span class="token string">"Welcome to my Golang column."</span>
	<span class="token keyword">if</span> intro <span class="token operator">!=</span> expected <span class="token punctuation">&#123;</span>
		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"The actual introduce %q is not the expected."</span><span class="token punctuation">,</span>
			intro<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// 默认只在测试失败的时候，才打印日志内容</span>
	t<span class="token punctuation">.</span><span class="token function">Logf</span><span class="token punctuation">(</span><span class="token string">"The expected introduce is %q.\n"</span><span class="token punctuation">,</span> expected<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 测试失败，显示t.Logf()中的内容</span>
<span class="token operator">--</span><span class="token operator">-</span> FAIL<span class="token punctuation">:</span> TestIntroduce <span class="token punctuation">(</span><span class="token number">0.00</span>s<span class="token punctuation">)</span>
    demo53_test<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">41</span><span class="token punctuation">:</span> The actual introduce <span class="token string">"Welcome to my Golang column."</span> is not the expected<span class="token punctuation">.</span>
    demo53_test<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">44</span><span class="token punctuation">:</span> The expected introduce is <span class="token string">"Welcome to my golang column."</span><span class="token punctuation">.</span>
FAIL
FAIL	puzzlers<span class="token operator">/</span>article20<span class="token operator">/</span>q2	<span class="token number">0.013</span>s
FAIL
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="t-Fail-与t-FailNow"><a href="#t-Fail-与t-FailNow" class="headerlink" title="t.Fail()与t.FailNow()"></a><code>t.Fail()</code>与<code>t.FailNow()</code></h1><p><code>t.Fail()</code>令测试结果为失败，但其后的代码依然会被执行。go 语言测试用例失败的触发必须手动调用<code>t.Fail/t.FailNow/t.Errorf/t.Fatalf</code>等方法才可以，并不像其它语言支持测试断言，由断言失败触发。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TestFail</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	t<span class="token punctuation">.</span><span class="token function">Fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"Failed."</span><span class="token punctuation">)</span> <span class="token comment">// 可以被执行到</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>t.FailNow()</code>也会令测试结果为失败，但其后的代码不再执行，不会影响其它测试用例的执行</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TestFail</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	t<span class="token punctuation">.</span><span class="token function">FailNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"Failed"</span><span class="token punctuation">)</span> <span class="token comment">// 不能被执行到</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="t-Errorf-与t-Error"><a href="#t-Errorf-与t-Error" class="headerlink" title="t.Errorf()与t.Error()"></a><code>t.Errorf()</code>与<code>t.Error()</code></h1><p>打印日志并使测试失败，等效于调用<code>t.Logf/t.Log</code>后，又调用了<code>t.Fail</code></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// t.Error 等效于在调用 t.Log 后，接着又调用了 t.Fail</span>
<span class="token comment">// Error is equivalent to Log followed by Fail.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>common<span class="token punctuation">)</span> <span class="token function">Error</span><span class="token punctuation">(</span>args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	c<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintln</span><span class="token punctuation">(</span>args<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">Fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Errorf is equivalent to Logf followed by Fail.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>common<span class="token punctuation">)</span> <span class="token function">Errorf</span><span class="token punctuation">(</span>format <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	c<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">Fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="t-Fatal与t-Fatalf方法"><a href="#t-Fatal与t-Fatalf方法" class="headerlink" title="t.Fatal与t.Fatalf方法"></a><code>t.Fatal</code>与<code>t.Fatalf</code>方法</h1><p>打印日志并使测试失败，在其后的代码不会被执行，当前测试用例立即结束，但不会影响其它测试用例，等效于调用<code>t.Logf/t.Log</code>后，又调用了<code>t.FailNow</code></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Fatal is equivalent to Log followed by FailNow.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>common<span class="token punctuation">)</span> <span class="token function">Fatal</span><span class="token punctuation">(</span>args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	c<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintln</span><span class="token punctuation">(</span>args<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">FailNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Fatalf is equivalent to Logf followed by FailNow.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>common<span class="token punctuation">)</span> <span class="token function">Fatalf</span><span class="token punctuation">(</span>format <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	c<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">FailNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/golang-test-coverage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
      <meta itemprop="description" content="后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/golang-test-coverage/" class="post-title-link" itemprop="url">go 语言 测试覆盖率</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-06-27 14:48:39" itemprop="dateCreated datePublished" datetime="2021-06-27T14:48:39+00:00">2021-06-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/golang/" itemprop="url" rel="index"><span itemprop="name">golang</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="覆盖率"><a href="#覆盖率" class="headerlink" title="覆盖率"></a>覆盖率</h1><p>语句的覆盖率是指在测试中至少被运行一次的代码占总代码数的比例。</p>
<h1 id="生成测试报告"><a href="#生成测试报告" class="headerlink" title="生成测试报告"></a>生成测试报告</h1><p>在生成报告之前，要确保所有的测试都正常通过。使用<code>go test</code>命令配合不同的参数标示可以生成不同类型的覆盖率分析报告</p>
<h2 id="使用标志coverprofile"><a href="#使用标志coverprofile" class="headerlink" title="使用标志coverprofile"></a>使用标志<code>coverprofile</code></h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> gott/prime -coverprofile<span class="token operator">=</span>c.out
ok      gott/prime      <span class="token number">0</span>.013s  coverage: <span class="token number">93.8</span>% of statements<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在运行每个测试前，会把参与测试的源代码拷贝一份，并对每个词法块插入一个布尔变量，来统计代码块在测试中是否被执行过，以此来统计代码覆盖率，统计日志数据写入c.out文件</p>
<p><img src="//img.gagahappy.cn/blog/2021/08/golang-test-coverage-1.png_b1" alt="go 语言 测试覆盖率" title="go 语言 测试覆盖率"></p>
<h2 id="使用标志covermode"><a href="#使用标志covermode" class="headerlink" title="使用标志covermode"></a>使用标志<code>covermode</code></h2><p>如果同时使用了<code>-covermode=count</code>，会在每个代码块插入计数器以统计代码块被执行的次数，用这个功能可以看到哪些代码是频繁执行的热点代码</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> gott/prime -coverprofile<span class="token operator">=</span>c.out -covermode<span class="token operator">=</span>count
ok      gott/prime      <span class="token number">0</span>.015s  coverage: <span class="token number">93.8</span>% of statements<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="//img.gagahappy.cn/blog/2021/08/golang-test-coverage-2.png_b1" alt="go 语言 测试覆盖率" title="go 语言 测试覆盖率"></p>
<h1 id="查看测试报告"><a href="#查看测试报告" class="headerlink" title="查看测试报告"></a>查看测试报告</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go tool cover -html<span class="token operator">=</span>c.out<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>运行后会自动在浏览器中打开，绿色的代码块代表被测试覆盖到了，红色的则表示没有被覆盖到。如果使用了<code> -covermode=count</code>标志，会用红、灰、绿 三种颜色表示代码被调用的频率，红色表示没有调用，灰色表示频率较低，绿色随颜色深浅表示不同程度的频率调用。具体可见上图测试报告。</p>
<h1 id="源文件"><a href="#源文件" class="headerlink" title="源文件"></a>源文件</h1><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// primes_test.go</span>
<span class="token keyword">func</span> <span class="token function">TestPrimes</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	max <span class="token operator">:=</span> <span class="token number">1000</span>
	primes <span class="token operator">:=</span> <span class="token function">GetPrimes</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>primes<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// primes.go</span>
<span class="token comment">// 查找质数</span>
<span class="token keyword">func</span> <span class="token function">GetPrimes</span><span class="token punctuation">(</span>max <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> max <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	marks <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">bool</span><span class="token punctuation">,</span> max<span class="token punctuation">)</span>
	<span class="token keyword">var</span> count <span class="token builtin">int</span>
	squareRoot <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span><span class="token function">Sqrt</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> squareRoot<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>marks<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">for</span> j <span class="token operator">:=</span> i <span class="token operator">*</span> i<span class="token punctuation">;</span> j <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> j <span class="token operator">+=</span> i <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> <span class="token operator">!</span>marks<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
					marks<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
					count<span class="token operator">++</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	primes <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> max<span class="token operator">-</span>count<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>marks<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
			primes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>primes<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> primes
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><ul>
<li>测试不可能是完整的，计算机科学家Edsger Dijkstra曾说过：“测试能证明缺陷存在，而无法证明没有缺陷。”</li>
<li>实现100%的测试覆盖率听起来很美，但是在具体实践中通常是不可行的，也不是值得推荐的做法。应该对更需要测试的地方添加测试代码，而不是一味的为每个方法都加入测试代码</li>
<li>测试覆盖率工具可以帮助我们快速识别测试薄弱的地方</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/nginx-set-gzip-http-version/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
      <meta itemprop="description" content="后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/nginx-set-gzip-http-version/" class="post-title-link" itemprop="url">nginx 设置 gzip http 版本</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-06-26 14:11:40" itemprop="dateCreated datePublished" datetime="2021-06-26T14:11:40+00:00">2021-06-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/nginx/" itemprop="url" rel="index"><span itemprop="name">nginx</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="设置gzip-http-version"><a href="#设置gzip-http-version" class="headerlink" title="设置gzip_http_version"></a>设置<code>gzip_http_version</code></h1><p>使用<code>ab</code> 测试网站，参数如下</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ab -n <span class="token number">50</span> -c <span class="token number">10</span> -H <span class="token string">"Accept-Encoding: gzip, deflate"</span> https://example.com/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>发现返回的文档没有被压缩，查看<code>nginx</code>日志也显示返回的是原始大小，查询资料后发现是<code>nginx</code> 配置<code>gzip_http</code>版本问题</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">gzip</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>

<span class="token directive"><span class="token keyword">gzip_vary</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">gzip_min_length</span> <span class="token number">1k</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">gzip_proxied</span> any</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">gzip_comp_level</span> <span class="token number">6</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">gzip_buffers</span> <span class="token number">16</span> <span class="token number">8k</span></span><span class="token punctuation">;</span>
gzip_http_version 1.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>gzip_http_version </code>设置为了1.1，而 <code>ab</code>只支持<code>http_version:1.0</code>，改为<code>1.0</code>即可。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx">gzip_http_version 1.0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>再次测试，返回数据是被压缩后的数据，从<code>nginx</code>日志也可以看到数据是压缩后的。类似的<code>ab</code> 的工具还有<a target="_blank" rel="noopener" href="https://github.com/JoeDog/siege">siege</a>，可以很好的支持<code>http 1.1</code></p>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>在<code>nginx</code>配置中，有些属性如果没有显示的进行设置，比如设置<code>gzip on;</code>时，没有设置<code>gzip_http_version</code>，<code>nginx</code>会启用默认值 <code>gzip_http_version:1.1;</code>，所以当你不想限制<code>http_version</code>的最低版本时，仅仅把<code>gzip_http_version</code>注释掉是不行的，你必须给其赋一个值才可以。类似这种问题不光在<code>nginx</code>配置中需要注意，在其它软件配置文件中也要注意</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/golang-external-test-packages/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
      <meta itemprop="description" content="后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/golang-external-test-packages/" class="post-title-link" itemprop="url">go 语言 外部测试包</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-06-24 16:29:21" itemprop="dateCreated datePublished" datetime="2021-06-24T16:29:21+00:00">2021-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/golang/" itemprop="url" rel="index"><span itemprop="name">golang</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="外部测试包"><a href="#外部测试包" class="headerlink" title="外部测试包"></a>外部测试包</h1><p>在测试代码的时候，会遇到包循环依赖导入的问题，Go语言规范是禁止包的循环依赖，为了解决这个问题，可以引入外部包。</p>
<p>外部包使用<code>package xxx_test</code>方式来命名，比如<code>package bytes_test</code>就是<code>src/btyes/buffer</code>外部包的命名方式，<code>_test</code>后缀告诉go test工具它应该建立一个额外的包来运行测试。</p>
<p><code>package xxx_test</code>中的<code>xxx_test</code>并不需要真的创建这样一个目录，而是在<code>xxx</code>包下的测试文件中引入这个包名就可以了。<code>btyes</code>包的源码目录结构如下</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/src/bytes
├── boundary_test.go
├── buffer.go
├── buffer_test.go
├── bytes.go
├── bytes_test.go
├── compare_test.go
├── example_test.go
├── export_test.go
├── reader.go
└── reader_test.go<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>通过外部测试包的方式可以解决导入包循环依赖的问题，因为外部测试包是一个独立的包，所以能够导入那些<code>依赖待测代码本身</code>的其他辅助包；包内的测试代码就无法做到这点。注意：外部包不能被其它包导入</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 文件 src/btyes/buffer_test.go</span>
<span class="token keyword">package</span> bytes_test <span class="token comment">// 'btyes目录下并不存在 bytes_test 目录'</span>
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token punctuation">.</span> <span class="token string">"bytes"</span>
	<span class="token operator">...</span> 代码片段
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestNewBuffer</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	buf <span class="token operator">:=</span> <span class="token function">NewBuffer</span><span class="token punctuation">(</span>testBytes<span class="token punctuation">)</span>
	<span class="token function">check</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"NewBuffer"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> testString<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token operator">...</span> 代码片段
<span class="token keyword">func</span> <span class="token function">empty</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">,</span> testname <span class="token builtin">string</span><span class="token punctuation">,</span> buf <span class="token operator">*</span>Buffer<span class="token punctuation">,</span> s <span class="token builtin">string</span><span class="token punctuation">,</span> fub <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p> <code>go list 命令</code></p>
<ul>
<li><p>通过<code>GoFiles</code>查看<code>bytes</code>包的Go源文件</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> list <span class="token operator">-</span>f<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token punctuation">.</span>GoFiles<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> bytes <span class="token comment">// => [buffer.go bytes.go reader.go]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>通过<code>TestGoFiles</code>查看<code>bytes</code>包内部的测试代码</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> list <span class="token operator">-</span>f<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token punctuation">.</span>TestGoFiles<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> bytes <span class="token comment">// => [export_test.go]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>通过<code>XTestGoFiles</code>查看<code>bytes</code>包的外部测试代码，也就是bytes_test包</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> list <span class="token operator">-</span>f<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token punctuation">.</span>XTestGoFiles<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> bytes
<span class="token comment">// => [buffer_test.go bytes_test.go compare_test.go example_test.go reader_test.go]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ul>
<h1 id="访问内部代码"><a href="#访问内部代码" class="headerlink" title="访问内部代码"></a>访问内部代码</h1><p>如果在测试中，需要对包内部的没有导出的函数进行测试，可以利用包内的 <code>_test.go</code>文件，如 <code>export_test.go</code>，在这个文件中将包的内部函数、方法导出，以供外部测试包使用。</p>
<p><code>indexBytePortable</code>方法在 src/bytes/bytes.go 中定义</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// src/bytes/bytes.go</span>
<span class="token keyword">func</span> <span class="token function">indexBytePortable</span><span class="token punctuation">(</span>s <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> c <span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span><span class="token comment">/* ... */</span><span class="token punctuation">&#125;</span> <span class="token comment">// 这是一个内部方法</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<p>把<code>bytes</code>包中的内部方法导出，供外部包<code>package bytes_test</code>使用。因为只有在测试时，才会把内部代码导出，所以导出内部代码是安全的</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// src/bytes/export_test.go</span>
<span class="token keyword">package</span> bytes
<span class="token comment">// Export func for testing</span>
<span class="token keyword">var</span> IndexBytePortable <span class="token operator">=</span> indexBytePortable <span class="token comment">// 赋值给包级可导出变量 IndexBytePortable</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<p>外部包使用导出的方法<code>IndexBytePortable</code></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// src/bytes/bytes_test.go</span>
<span class="token keyword">package</span> bytes_test

<span class="token keyword">func</span> <span class="token function">TestIndexByte</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tt <span class="token operator">:=</span> <span class="token keyword">range</span> indexTests <span class="token punctuation">&#123;</span>
		<span class="token operator">...</span> 代码片段
		posp <span class="token operator">:=</span> <span class="token function">IndexBytePortable</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token comment">// 导出的内部方法在这里被使用</span>
		<span class="token keyword">if</span> posp <span class="token operator">!=</span> tt<span class="token punctuation">.</span>i <span class="token punctuation">&#123;</span>
			t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">`indexBytePortable(%q, '%c') = %v`</span><span class="token punctuation">,</span> tt<span class="token punctuation">.</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> posp<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>测试文件<code>export_test.go</code>并没有定义测试代码，它只是通过<code>bytes.IndexBytePortable</code>简单导出了内部的<code>indexBytePortable</code>函数，这个技巧可以广泛用于位于外部测试包的白盒测试</p>
<h1 id="示例：包循环依赖"><a href="#示例：包循环依赖" class="headerlink" title="示例：包循环依赖"></a>示例：包循环依赖</h1><p>目录结构</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gott
├── go.mod
├── hi
│   └── hi.go
├── pprint
│   ├── pprint.go
│   └── pprint_test.go<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>hi.go 文件，引用了 pprint 包</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> hi

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"gott/pprint"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	pprint <span class="token operator">:=</span> pprint<span class="token punctuation">.</span><span class="token function">PPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>pprint<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>pprint.go 文件</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> pprint

<span class="token keyword">func</span> <span class="token function">PPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token string">"I'm PPrint()"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>pprint_test.go 测试文件，在 pprint 包中引入了 hi 包，而 hi 包中已经引入了 pprint 包，这就导致了 包循环依赖</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> pprint

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"gott/hi"</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestPPrint</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">PPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	hi<span class="token punctuation">.</span><span class="token function">Say</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"expect call PPrint"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>执行测试，提示 import cycle not allowed in test</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> -v gott/pprint
<span class="token comment"># gott/pprint</span>
package gott/pprint <span class="token punctuation">(</span>test<span class="token punctuation">)</span>
        imports gott/hi
        imports gott/pprint: <span class="token function">import</span> cycle not allowed <span class="token keyword">in</span> <span class="token builtin class-name">test</span>
FAIL    gott/pprint <span class="token punctuation">[</span>setup failed<span class="token punctuation">]</span>
FAIL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>修改 pprint_test.go 测试文件，使用外部测试包 <code>pprint_test</code></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> pprint_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"gott/hi"</span>
	<span class="token comment">// 导入 要进行测试的 pprint 包本身</span>
	<span class="token string">"gott/pprint"</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestPPrint</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	pprint<span class="token punctuation">.</span><span class="token function">PPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	hi<span class="token punctuation">.</span><span class="token function">Say</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"expect call PPrint"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>&quot;gott/pprint&quot;</code>：导入 要进行测试的 pprint 包本身，没有引入外部包时，不需要导入被测试的包本身</p>
<p>执行测试，测试通过</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> -v gott/pprint
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestPPrint
I'm PPrint<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pprint_test.go:12: <span class="token function">expect</span> call PPrint
--- PASS: TestPPrint <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      gott/pprint     <span class="token punctuation">(</span>cached<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>使用 Go 官方的代码风格：pprint_test.go 文件，因为pprint_test在 pprint 目录下，通过在 import 时，使用 <code>.</code> 选项，可以直接调用PPrint()方法，这使得调用包内的方法和内部测试包一致，整体代码风格得到统一</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> pprint_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"gott/hi"</span>
	<span class="token punctuation">.</span> <span class="token string">"gott/pprint"</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestPPrint</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">PPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	hi<span class="token punctuation">.</span><span class="token function">Say</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"expect call PPrint"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备10044755号 </a>
  </div>

<div class="copyright">
  &copy; 2009 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">戛戛Happy</span>
  <span class="with-love">
    <i class="fa fa-chart-bar"></i>
  </span>
  <span itemprop="cnzz"><script type="text/javascript" src="//s4.cnzz.com/z_stat.php?id=2325808&web_id=2325808"></script></span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>




  




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"moonfox","repo":"gitalk","client_id":"2a9c7ba27dd4a9376f8c","client_secret":"cb4fa8779f853f735779a518c57e894a8ee30b09","admin_user":"moonfox","distraction_free_mode":false,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js","integrity":"sha256-Pmj85ojLaPOWwRtlMJwmezB/Qg8BzvJp5eTzvXaYAfA="},"path_md5":"index.html"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
