<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <meta name="google-site-verification" content="mRjQM6azHRnllmCObIorLO1p8dqt92U33mbEzoA2HnU">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha256-xejo6yLi6vGtAjcMIsY8BHdKsLg7QynVlFMzdQgUuy8=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.gagahappy.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.12.3","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="雅思, 四级, 六级, 英语, 后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
<meta property="og:type" content="website">
<meta property="og:title" content="睡月花儿">
<meta property="og:url" content="https://www.gagahappy.com/">
<meta property="og:site_name" content="睡月花儿">
<meta property="og:description" content="雅思, 四级, 六级, 英语, 后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
<meta property="og:locale">
<meta property="article:author" content="戛戛Happy">
<meta property="article:tag" content="雅思, 四级, 六级, 英语, 后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.gagahappy.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>睡月花儿</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-17621945-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-17621945-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/rss2.xml" title="睡月花儿" type="application/rss+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">睡月花儿</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-blog"><a href="https://blog.gagahappy.cn/" rel="noopener" target="_blank"><i class="fa fa-coffee fa-fw"></i>Blog</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">12</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Posts<span class="badge">68</span></a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="戛戛Happy"
      src="/apple-touch-icon.png">
  <p class="site-author-name" itemprop="name">戛戛Happy</p>
  <div class="site-description" itemprop="description">雅思, 四级, 六级, 英语, 后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby</div>
</div>
  <div class="">

  <div class="">

      <div class="social-item">
        <a target="_blank" class="social-link" href="/rss2.xml">
          <span class="icon">
            <i class="fa fa-rss"></i>
          </span>

          <span class="label">RSS</span>
        </a>
      </div>
  </div>
</div>

  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/ielts06/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
      <meta itemprop="description" content="雅思, 四级, 六级, 英语, 后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 睡月花儿">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/ielts06/" class="post-title-link" itemprop="url">ielts06</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-20 15:26:15" itemprop="dateCreated datePublished" datetime="2025-05-20T15:26:15+00:00">2025-05-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/ielts/" itemprop="url" rel="index"><span itemprop="name">雅思</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="英文故事：-”The-Forgotten-Turret”"><a href="#英文故事：-”The-Forgotten-Turret”" class="headerlink" title="英文故事：**”The Forgotten Turret”**"></a>英文故事：**”The Forgotten Turret”**</h1><p>On a remote <strong>continent</strong>, archaeologists set out to <strong>discover</strong> a hidden fortress believed to date back to the 12th century. Its main <strong>turret</strong> had fallen into <strong>dormancy</strong>, hidden beneath layers of earth. The team, led by a brilliant <strong>coordinator</strong>, used <strong>statistics</strong> and satellite data to <strong>calculate</strong> its approximate location.</p>
<p>The weather was tough—<strong>atmospheric</strong> pressure and <strong>stuffy</strong> air made breathing difficult. Despite this, the <strong>major</strong> discovery drove them on. When they tried to unearth the turret, a worker accidentally <strong>mishandled</strong> a tool and nearly caused a collapse. Luckily, no one was injured, and the event was later deemed <strong>excusable</strong>.</p>
<p>The coordinator <strong>proposed</strong> to <strong>demolish</strong> some unstable walls to safely access the core. Some historians protested, citing <strong>tradition</strong> and cultural <strong>honour</strong>, but the structure wasn’t <strong>durable</strong> enough to withstand continued <strong>suppression</strong> from the weight of time.</p>
<p>Among the ruins, they found old scrolls, one of which contained what seemed like an ancient <strong>antidote</strong> recipe. Though not <strong>necessarily</strong> magical, its ingredients were unusual.</p>
<p>After their return, a museum offered a paid <strong>subscription</strong> for monthly updates about the site. The coordinator received a special <strong>licence</strong> to curate the relics. At the celebration event, one researcher appeared nearly <strong>naked</strong>, a result of a lost bet. It was <strong>mainly</strong> a humorous moment, though he felt slightly <strong>guilty</strong>.</p>
<p>Finally, a loose stone dislodged during the ceremony—perhaps a sign that history still had secrets to tell, waiting to <strong>dislodge</strong> themselves.</p>
<h1 id="单词造句表格"><a href="#单词造句表格" class="headerlink" title="单词造句表格"></a>单词造句表格</h1><table>
<thead>
<tr>
<th>序号</th>
<th>单词</th>
<th>英文例句</th>
<th>中文翻译</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>calculate</td>
<td>Engineers [/ˌendʒɪˈnɪr/] calculate the bridge’s weight limit carefully.</td>
<td>工程师仔细计算桥的承重极限。</td>
</tr>
<tr>
<td>2</td>
<td>dormancy</td>
<td>Seeds can remain in dormancy for months before germinating.</td>
<td>种子在发芽之前可以保持休眠状态数月之久</td>
</tr>
<tr>
<td>3</td>
<td>particular</td>
<td>Is there a particular reason why you’re upset?</td>
<td>你生气有特别的原因吗？</td>
</tr>
<tr>
<td>4</td>
<td>subscription</td>
<td>I bought a subscription to the online magazine.</td>
<td>我订阅了这本在线杂志。</td>
</tr>
<tr>
<td>5</td>
<td>demolish</td>
<td>They plan to demolish the old building next month.</td>
<td>他们计划下个月拆除那栋老楼。</td>
</tr>
<tr>
<td>6</td>
<td>durable</td>
<td>These boots are made of durable leather.</td>
<td>这双靴子由耐用的皮革制成。</td>
</tr>
<tr>
<td>7</td>
<td>tradition</td>
<td>It’s a family tradition to gather at New Year.</td>
<td>一家人在新年团聚是我们的传统。</td>
</tr>
<tr>
<td>8</td>
<td>statistics</td>
<td>Statistics show a rise in employment this year.</td>
<td>统计数据显示今年就业率上升。</td>
</tr>
<tr>
<td>9</td>
<td>stuffy</td>
<td>The classroom was hot and stuffy.</td>
<td>教室又热又闷。</td>
</tr>
<tr>
<td>10</td>
<td>approximately</td>
<td>The flight takes approximately ten hours.</td>
<td>飞行时间大约为十小时。</td>
</tr>
<tr>
<td>11</td>
<td>excusable</td>
<td>His mistake was excusable under the circumstances.</td>
<td>在这种情况下他的错误可以原谅。</td>
</tr>
<tr>
<td>12</td>
<td>propose</td>
<td>He proposed a new solution to the problem.</td>
<td>他提出了一个新解决方案。</td>
</tr>
<tr>
<td>13</td>
<td>atmospheric</td>
<td>The atmospheric pressure dropped suddenly.</td>
<td>大气压突然下降。</td>
</tr>
<tr>
<td>14</td>
<td>honour</td>
<td>The soldier was buried with full honour.</td>
<td>这名士兵以最高荣誉下葬。</td>
</tr>
<tr>
<td>15</td>
<td>dislodge</td>
<td>They tried to dislodge the rock from the road.</td>
<td>他们试图将那块岩石从路上移开。(v.（把某物）强行去除，取出)</td>
</tr>
<tr>
<td>16</td>
<td>licence</td>
<td>She finally got her driving licence.</td>
<td>她终于拿到了驾照。</td>
</tr>
<tr>
<td>17</td>
<td>major</td>
<td>Climate change is a major global issue.</td>
<td>气候变化是一个主要的全球问题。</td>
</tr>
<tr>
<td>18</td>
<td>antidote</td>
<td>The nurse administered an antidote for the poison /ˈpɔɪzn/.</td>
<td>护士给中毒者注射了解毒剂( administer 给予，施用（药物等）)</td>
</tr>
<tr>
<td>19</td>
<td>discover</td>
<td>Scientists hope to discover new planets.</td>
<td>科学家希望发现新的行星。</td>
</tr>
<tr>
<td>20</td>
<td>necessarily</td>
<td>More money doesn’t necessarily [/ˌnesəˈserəli/] mean more happiness.</td>
<td>更多的钱不一定意味着更多的幸福。(adv.必然地)</td>
</tr>
<tr>
<td>21</td>
<td>turret</td>
<td>The castle had four tall turrets [/ˈtɜːrət/] at each corner.</td>
<td>城堡四角都有高塔楼。</td>
</tr>
<tr>
<td>22</td>
<td>continent</td>
<td>Africa is a continent [/ˈkɑːntɪnənt/] rich in natural resources.</td>
<td>非洲是一个自然资源丰富的大陆。</td>
</tr>
<tr>
<td>23</td>
<td>mishandle</td>
<td>The courier mishandled the fragile [/ˈfrædʒ(ə)l/] package.</td>
<td>快递员处理易碎包裹不当。</td>
</tr>
<tr>
<td>24</td>
<td>suppression</td>
<td>The regime relied on suppression to maintain power.</td>
<td>该政权依靠镇压来维持权力。(镇压，压制)</td>
</tr>
<tr>
<td>25</td>
<td>mainly</td>
<td>The course is mainly about data science.</td>
<td>这门课程主要是关于数据科学的。</td>
</tr>
<tr>
<td>26</td>
<td>naked</td>
<td>The statue [/ˈstætʃuː/] depicts a naked warrior.</td>
<td>这尊雕像描绘了一位裸体战士。</td>
</tr>
<tr>
<td>27</td>
<td>coordinator</td>
<td>The event coordinator did an excellent job.</td>
<td>活动协调人做得非常出色。</td>
</tr>
<tr>
<td>28</td>
<td>guilty</td>
<td>He felt guilty for forgetting her birthday.</td>
<td>他因忘记她的生日而感到内疚。</td>
</tr>
</tbody></table>
<h1 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h1><p><strong>administer</strong> 和 <strong>inject</strong> 有区别：</p>
<ul>
<li><strong>administer an antidote</strong> 更正式，意思是“给予（药物、解毒剂等）”，不仅限于注射，也包括口服、滴注等方式。</li>
<li><strong>inject an antidote</strong> 专指“用注射的方式给药”。</li>
</ul>
<p>如果你确定解毒剂是通过注射给的，用 <strong>inject</strong> 也可以，但如果不确定具体方式，或者想表达更广泛的给药方式，<strong>administer</strong> 更合适。</p>
<p>所以，句子可以改成：</p>
<ul>
<li>The nurse <strong>injected</strong> an antidote to the poisoned person.（强调注射）</li>
</ul>
<p>但更常见和正式的是：</p>
<ul>
<li>The nurse <strong>administered</strong> an antidote to the poisoned person.</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/mysql-scan-full-by-or/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
      <meta itemprop="description" content="雅思, 四级, 六级, 英语, 后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 睡月花儿">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/mysql-scan-full-by-or/" class="post-title-link" itemprop="url">mysql or 导致的全表扫描</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-12-14 13:56:15" itemprop="dateCreated datePublished" datetime="2021-12-14T13:56:15+00:00">2021-12-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="or-导致的全表扫描"><a href="#or-导致的全表扫描" class="headerlink" title="or 导致的全表扫描"></a>or 导致的全表扫描</h1><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> id <span class="token keyword">from</span> tradelog <span class="token keyword">where</span> tradeid <span class="token operator">=</span> <span class="token string">'12'</span> <span class="token operator">or</span> operator <span class="token operator">=</span> <span class="token number">10</span> <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+---------------+------+---------+------+--------+----------+-------------+</span>
<span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+---------------+------+---------+------+--------+----------+-------------+</span>
<span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> tradeid       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">389107</span> <span class="token operator">|</span>    <span class="token number">10.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+---------------+------+---------+------+--------+----------+-------------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>查询条件中有 or 时，mysql 会分别查询每一个条件，然后再把结果合并在一起。</p>
<p>先对 tradeid = ‘12’ 进行判断，发现可以使用索引，再对 operator = 10 进行判断，发现不能使用索引，只好全表扫描，即然都全表扫描了，顺带也就可以判断当前记录的 tradeid 是否等于 12，就不需要在单独再搜索 tradeid 索引树了。</p>
<p>所以当 or 条件中出现没有索引的字段会导致使用全表扫描。如果出现的字段都有索引，mysql会尽量使用每个列的索引</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> id <span class="token keyword">from</span> tradelog <span class="token keyword">where</span> tradeid <span class="token operator">=</span> <span class="token string">'12'</span> <span class="token operator">or</span> id <span class="token operator">=</span><span class="token number">10</span>  <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+----------+-------------+-----------------+-----------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>    <span class="token operator">|</span> <span class="token keyword">type</span>        <span class="token operator">|</span> possible_keys   <span class="token operator">|</span> <span class="token keyword">key</span>             <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+----------+-------------+-----------------+-----------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> tradelog <span class="token operator">|</span> index_merge <span class="token operator">|</span> <span class="token keyword">PRIMARY</span><span class="token punctuation">,</span>tradeid <span class="token operator">|</span> tradeid<span class="token punctuation">,</span><span class="token keyword">PRIMARY</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+----------+-------------+-----------------+-----------------+</span>

<span class="token operator">+</span><span class="token comment">---------+------+------+----------+-------------------------------------------+</span>
<span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                                     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+------+------+----------+-------------------------------------------+</span>
<span class="token operator">|</span> <span class="token number">131</span><span class="token punctuation">,</span><span class="token number">4</span>   <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">union</span><span class="token punctuation">(</span>tradeid<span class="token punctuation">,</span><span class="token keyword">PRIMARY</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+------+------+----------+-------------------------------------------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>虽然条件中也有 or ，但 tradeid 和 id 都有索引，mysql 分别单独对这两个索引扫描，然后把找到的结果再合并到一起。执行计划显示 <code>type:index_merge</code> ， <code>key:tradeid,PRIMARY</code>，<code>Extra:Using union</code></p>
<p>同样的条件，把 or 换成 and 时是可以走索引的，因为找的是要满足所有条件的记录，那么就可以在最小的索引树先找到一条满足条件的记录，再检查这条记录是否还满足其它条件</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> id <span class="token keyword">from</span> tradelog <span class="token keyword">where</span> tradeid <span class="token operator">=</span> <span class="token string">'12'</span> <span class="token operator">and</span>  operator <span class="token operator">=</span> <span class="token number">10</span> <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+---------------+---------+---------+-------+------+----------+-------------+</span>
<span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+---------------+---------+---------+-------+------+----------+-------------+</span>
<span class="token operator">|</span> ref  <span class="token operator">|</span> tradeid       <span class="token operator">|</span> tradeid <span class="token operator">|</span> <span class="token number">131</span>     <span class="token operator">|</span> const <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">10.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+---------------+---------+---------+-------+------+----------+-------------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>key:tradeid  显示使用了 tradeid 索引。通过索引树先找到一条  tradeid = ‘12’的记录，再回表查询 operator 是否等于 10。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/mysql-how-add-index-for-string/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
      <meta itemprop="description" content="雅思, 四级, 六级, 英语, 后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 睡月花儿">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/mysql-how-add-index-for-string/" class="post-title-link" itemprop="url">mysql 如何为字符串合理创建索引</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-20 19:21:16" itemprop="dateCreated datePublished" datetime="2021-11-20T19:21:16+00:00">2021-11-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>对于一般长度的字符串，用整个字符串直接作为索引即可，但对于比较长的字符串，比如email，身份证号如果直接作为索引，会占用较大的磁盘空间</p>
<h1 id="前缀索引"><a href="#前缀索引" class="headerlink" title="前缀索引"></a>前缀索引</h1><p>可以为较长的字符串设置前缀索引，缩短索引字段的长度，减少占用磁盘的空间</p>
 <pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> users <span class="token keyword">add</span> <span class="token keyword">index</span> index1<span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">alter</span> <span class="token keyword">table</span> users <span class="token keyword">add</span> <span class="token keyword">index</span> index2<span class="token punctuation">(</span>email<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>索引 index1 包含了整个字符串，而 index2 只包含了前6个字符串，比 index1 占用更少的空间。那么如何定义前缀长度呢？如果太短，索引的区分度就会不高，增加额外的扫描次数，查询效率下降，太长又不能节省空间。可以用下面的方法进行判断，选择最接近1的，同时长度最短的来作为前缀。</p>
<h2 id="前缀索引的长度"><a href="#前缀索引的长度" class="headerlink" title="前缀索引的长度"></a>前缀索引的长度</h2><p>首先计算出这个列上有多少个不同的值(计为total)</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> email<span class="token punctuation">)</span> <span class="token keyword">as</span> total <span class="token keyword">from</span> users<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后取不同长度的前缀，计算有多少个不同的值，分别除以 total，选择最接近1的且前缀较短的</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> 
  <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">left</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>）<span class="token operator">/</span> total <span class="token keyword">as</span> L4<span class="token punctuation">,</span>
  <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">left</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>）<span class="token operator">/</span> total <span class="token keyword">as</span> L5<span class="token punctuation">,</span>
  <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">left</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span>）<span class="token operator">/</span> total <span class="token keyword">as</span> L6<span class="token punctuation">,</span>
  <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">left</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span>）<span class="token operator">/</span> total <span class="token keyword">as</span> L7<span class="token punctuation">,</span>
<span class="token keyword">from</span> users<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>假设结果为： L4 40%，L5  90%， L6 96% ，L7 96%。而你只接受大于95%的区分度，L6/L7等符合，那么选择前缀为6的最为适合。</p>
<h2 id="增加扫描次数"><a href="#增加扫描次数" class="headerlink" title="增加扫描次数"></a>增加扫描次数</h2><p>假设users表有如下记录，分别建立索引 index1(email)，index2(email,5)</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">id<span class="token punctuation">,</span>  email<span class="token punctuation">,</span>              <span class="token punctuation">,</span>username<span class="token punctuation">,</span> adders
id1<span class="token punctuation">,</span> xiaoming123<span class="token variable">@xyz.com</span> <span class="token punctuation">,</span>省略
id2<span class="token punctuation">,</span> xiaoming456<span class="token variable">@xyz.com</span> <span class="token punctuation">,</span>省略
id3<span class="token punctuation">,</span> xiaoming789<span class="token variable">@xyz.com</span> <span class="token punctuation">,</span>省略
id4<span class="token punctuation">,</span> xiaomingABC<span class="token variable">@xyz.com</span> <span class="token punctuation">,</span>省略
id5<span class="token punctuation">,</span> zhanghao123<span class="token variable">@xyz.com</span>    <span class="token punctuation">,</span>省略
id6<span class="token punctuation">,</span> zhanghao456<span class="token variable">@xyz.com</span>    <span class="token punctuation">,</span>省略<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>索引 index1的页节点数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">(</span>xiaoming123<span class="token variable">@xyz.com</span><span class="token punctuation">,</span>id1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>xiaoming456<span class="token variable">@xyz.com</span><span class="token punctuation">,</span>id2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>xiaoming789<span class="token variable">@xyz.com</span><span class="token punctuation">,</span>id3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>xiaomingABC<span class="token variable">@xyz.com</span><span class="token punctuation">,</span>id4<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>zhang123<span class="token variable">@xyz.com</span><span class="token punctuation">,</span>id5<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>zhang456<span class="token variable">@xyz.com</span><span class="token punctuation">,</span>id6<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>索引 index2的页节点数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">(</span>xiaom<span class="token punctuation">,</span>id1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>xiaom<span class="token punctuation">,</span>id2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>xiaom<span class="token punctuation">,</span>id3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>xiaom<span class="token punctuation">,</span>id4<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>zhang<span class="token punctuation">,</span>id5<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>zhang<span class="token punctuation">,</span>id6<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可以看到，前缀索引占用更少的数据空间</p>
<p>索引查询过程</p>
<p>现查询email为<code>xiaoming456@xyz.com&#39;</code>的用户信息</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> email<span class="token operator">=</span><span class="token string">'xiaoming456@xyz.com'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>index1索引查询过程</p>
<ol>
<li>搜索index1索引树，找到等于 <code>xiaoming456@xyz.com</code> 的记录，取出主键的值 <code>id2</code></li>
<li>根据主键值 id2 回表查询，把记录放入返回结果集中</li>
<li>再接着向右移动，发现记录不符，返回，查询结束，把结果集返回客户端</li>
</ol>
<p>index2索引查询过程</p>
<ol>
<li>搜索index2索引树，找到等于 <code>xiaom</code> 的记录(取前5位进行查询)，取出主键的值 <code>id1</code></li>
<li>根据主键值 id1 回表查询，发现email值不等于<code>xiaoming456@xyz.com</code></li>
<li>再接着向右移动，发现等于<code>xiaom</code>，取出主键的值 <code>id2</code></li>
<li>根据主键值 id2  回表查询，发现email值等于<code>xiaoming456@xyz.com</code>，放入返回结果集</li>
<li>重复以上过程，直到遇到<code>zhang</code>时，查询结束</li>
</ol>
<p>使用前缀索引 index2 一共需要查找4次，增加了扫描的次数。但如果把前缀索引设置为email(9)，也只需要查找一次，因为等于<code>xiaoming4</code>只有一条，找到后查询也结束了。</p>
<p>通过选择适当的前缀索引的长度，即节省空间，查询成本也不会太高</p>
<h2 id="覆盖索引无效"><a href="#覆盖索引无效" class="headerlink" title="覆盖索引无效"></a>覆盖索引无效</h2><p>同样是查询<code>select id, email from users where email=&#39;xiaoming456@xyz.com&#39;;</code></p>
<ul>
<li>如果在 email 上建立普通索引，在找到记录后，由于索引包含了id的值，不用回表，直接返回结果即可</li>
<li>如果在 email 上建立前缀索引，在找到记录后，由于索引信息不完整，即使包含了id的值，也需要回表查询是否与email的完整值相匹配</li>
</ul>
<p>这样就导致了在前缀索引上，无法使用覆盖索引对查询性能的优化</p>
<h1 id="Hash字段"><a href="#Hash字段" class="headerlink" title="Hash字段"></a>Hash字段</h1><p>比如对身份证进行查询，其长度为18位，直接建立索引会占用较多的空间，如果使用前缀索引只取前几位但相同的概率很大，取太长又不能节省空间，此时可以添加一个字段，用来存放身份证的 hash 值，并为这个hash字段建立索引</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> t <span class="token keyword">add</span> idcard_hash <span class="token keyword">int</span> <span class="token keyword">unsigned</span><span class="token punctuation">,</span> <span class="token keyword">add</span> <span class="token keyword">index</span><span class="token punctuation">(</span>idcard_hash<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>索引的长度变成了 4 个字节，就算算上hash字段本身占用的空间，也要比原来小了很多。由于hash值存在冲突，在查询时还要加上身份证字段，确保精确匹配以取到正确的记录，这样就可以即节省空间，又高效的查询了</p>
 <pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> idcard_hash<span class="token operator">=</span>hash_algorithm<span class="token punctuation">(</span><span class="token string">'input_id_card_string'</span><span class="token punctuation">)</span> <span class="token operator">and</span> id_card<span class="token operator">=</span><span class="token string">'input_id_card_string'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p>hash字段的缺点</p>
<ul>
<li>不能进行范围查询</li>
<li>使用hash函数会消耗CPU</li>
</ul>
<p>这里其实还有一个思路，把身份证倒序存储，这样就不用额外再建立字段，同时可以使用前缀索引，但至少要用前8位来建立前缀索引，即8字节，其占用空间和使用hash字段就差不多了，因为是前缀索引，必定要回表查询，增加了扫描次数，查询性能也有没hash字段稳定，况且8位应该是不够的，占用空间肯定要比使用hash字段要大。</p>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><ol>
<li>直接创建完整索引，这样可能比较占用空间</li>
<li>创建前缀索引，节省空间，但会增加查询扫描次数，并且不能使用覆盖索引</li>
<li>倒序存储，再创建前缀索引，用于绕过字符串本身前缀的区分度不够的问题</li>
<li>创建 hash 字段索引，查询性能稳定，有额外的存储和计算消耗，跟第三种方式一样，都不支持范围扫描</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/mysql-auto-increment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
      <meta itemprop="description" content="雅思, 四级, 六级, 英语, 后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 睡月花儿">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/mysql-auto-increment/" class="post-title-link" itemprop="url">mysql 自增值规则</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-15 15:28:20" itemprop="dateCreated datePublished" datetime="2021-11-15T15:28:20+00:00">2021-11-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Auto-increment"><a href="#Auto-increment" class="headerlink" title="Auto_increment"></a>Auto_increment</h1><p>表结构如下，且假设当前系统中只有一个连接</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>t<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>a<span class="token punctuation">`</span> <span class="token keyword">int</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>b<span class="token punctuation">`</span> <span class="token keyword">int</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>a<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>a<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>b<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>b<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>建表时把主键id设置为<code>id int(11) NOT NULL AUTO_INCREMEN</code>，在插入数据时，如果不指定id，系统会为id自动设置值 ，并把Auto_increment的值，作为下一条记录id的值</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> t<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------+------+------+</span>
<span class="token operator">|</span> id     <span class="token operator">|</span> a    <span class="token operator">|</span> b    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+------+------+</span>
<span class="token operator">|</span> <span class="token number">200001</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+------+------+</span>

<span class="token keyword">show</span> <span class="token keyword">table</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'t'</span>\G
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
   Index_length: <span class="token number">32768</span>
      Data_free: <span class="token number">10485760</span>
 <span class="token keyword">Auto_increment</span>: <span class="token number">200002</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>再插入时如果没有指定id，则使用200002作为其值，Auto_increment的值更新为200003</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> t<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------+------+------+</span>
<span class="token operator">|</span> id     <span class="token operator">|</span> a    <span class="token operator">|</span> b    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+------+------+</span>
<span class="token operator">|</span> <span class="token number">200001</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">200002</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+------+------+</span>

<span class="token keyword">show</span> <span class="token keyword">table</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'t'</span>\G
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
   Index_length: <span class="token number">32768</span>
      Data_free: <span class="token number">10485760</span>
 <span class="token keyword">Auto_increment</span>: <span class="token number">200003</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果把id=200001记录删除，然后指定id的值为200001，插入这样一条记录，那么Auto_increment的值不增长，依然为200003。同时可以看到，由于默认是主键索引排序，即使id=200001被删除后，再次插入，也排在了200002的前面</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">delete</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">200001</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t<span class="token punctuation">(</span>id<span class="token punctuation">,</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">200001</span><span class="token punctuation">,</span><span class="token number">200001</span><span class="token punctuation">,</span><span class="token number">200001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------+--------+--------+</span>
<span class="token operator">|</span> id     <span class="token operator">|</span> a      <span class="token operator">|</span> b      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+--------+--------+</span>
<span class="token operator">|</span> <span class="token number">200001</span> <span class="token operator">|</span> <span class="token number">200001</span> <span class="token operator">|</span> <span class="token number">200001</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">200002</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+--------+--------+</span>

<span class="token keyword">show</span> <span class="token keyword">table</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'t'</span>\G
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
   Index_length: <span class="token number">32768</span>
      Data_free: <span class="token number">10485760</span>
 <span class="token keyword">Auto_increment</span>: <span class="token number">200003</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>再插入一条记录也可以验证，新记录的id值为200003。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> t<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------+--------+--------+</span>
<span class="token operator">|</span> id     <span class="token operator">|</span> a      <span class="token operator">|</span> b      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+--------+--------+</span>
<span class="token operator">|</span> <span class="token number">200001</span> <span class="token operator">|</span> <span class="token number">200001</span> <span class="token operator">|</span> <span class="token number">200001</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">200002</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">200003</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+--------+--------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>还可以手动插入一个不连续的id:200006</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> t<span class="token punctuation">(</span>id<span class="token punctuation">,</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">200006</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>此时 Auto_increment的值为 200007，如果插入id比它小的值，则 Auto_incrementr的值不增长，依然为 200007</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> t<span class="token punctuation">(</span>id<span class="token punctuation">,</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">200005</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------+--------+--------+</span>
<span class="token operator">|</span> id     <span class="token operator">|</span> a      <span class="token operator">|</span> b      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+--------+--------+</span>
<span class="token operator">|</span> <span class="token number">200001</span> <span class="token operator">|</span> <span class="token number">200001</span> <span class="token operator">|</span> <span class="token number">200001</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">200002</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">200003</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">200005</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">200006</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+--------+--------+</span>

<span class="token keyword">show</span> <span class="token keyword">table</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'t'</span>\G
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
   Index_length: <span class="token number">32768</span>
      Data_free: <span class="token number">10485760</span>
 <span class="token keyword">Auto_increment</span>: <span class="token number">200007</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>在以上操作中，如果通过<code>show table status like</code>查看<code>Auto_increment</code>的值没有变化，运行<code>analyze table t</code>手动更新表的统计信息后再查看</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/mysql-update-with-limit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
      <meta itemprop="description" content="雅思, 四级, 六级, 英语, 后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 睡月花儿">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/mysql-update-with-limit/" class="post-title-link" itemprop="url">mysql limit 的妙用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-09-04 13:15:32" itemprop="dateCreated datePublished" datetime="2021-09-04T13:15:32+00:00">2021-09-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>更新无索引的列，会导致全表被锁，其它线程无法更新表中的数据，如果加入了<code>limit N</code>关键字，可以减少被锁定的行，在一定程度上可以提高并发</p>
<p>表结构及数据如下</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token punctuation">`</span>t<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>age<span class="token punctuation">`</span> <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>ismale<span class="token punctuation">`</span> <span class="token keyword">tinyint</span> <span class="token keyword">default</span> <span class="token boolean">null</span>
<span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">innodb</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'d001'</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'d003'</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">'d005'</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string">'d007'</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token string">'d009'</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token string">'d011'</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+------+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name <span class="token operator">|</span> age  <span class="token operator">|</span> ismale <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> d001 <span class="token operator">|</span>   <span class="token number">30</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> d003 <span class="token operator">|</span>   <span class="token number">30</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span> d005 <span class="token operator">|</span>   <span class="token number">30</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">7</span> <span class="token operator">|</span> d007 <span class="token operator">|</span>   <span class="token number">30</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">9</span> <span class="token operator">|</span> d009 <span class="token operator">|</span>   <span class="token number">30</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">11</span> <span class="token operator">|</span> d011 <span class="token operator">|</span>   <span class="token number">30</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+--------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="不加入limit锁全表"><a href="#不加入limit锁全表" class="headerlink" title="不加入limit锁全表"></a>不加入<code>limit</code>锁全表</h2><table>
<thead>
<tr>
<th>时刻</th>
<th>Session A</th>
<th>Session B</th>
</tr>
</thead>
<tbody><tr>
<td>T1</td>
<td>begin;</td>
<td></td>
</tr>
<tr>
<td></td>
<td>update t set age=31 where name=’d003’;</td>
<td></td>
</tr>
<tr>
<td>T2</td>
<td></td>
<td>Begin;</td>
</tr>
<tr>
<td></td>
<td></td>
<td>update t set age=31 where name=’d005’;<font color=red>(blocked)</font></td>
</tr>
<tr>
<td></td>
<td></td>
<td>update t set age=31 where id=5;<font color=red>(blocked)</font></td>
</tr>
<tr>
<td></td>
<td></td>
<td>insert into t values(2,’d002’,30,1);<font color=red>(blocked)</font></td>
</tr>
<tr>
<td></td>
<td></td>
<td>insert into t values(12,’d012’,30,1);<font color=red>(blocked)</font></td>
</tr>
</tbody></table>
<h3 id="SessionA的加锁范围"><a href="#SessionA的加锁范围" class="headerlink" title="SessionA的加锁范围"></a>SessionA的加锁范围</h3><p>主键索引<code>id</code>锁的范围是[infimum，supremum]</p>
<p>由于name列没有索引，<code>where name=&#39;d003&#39;</code>查询时走主键索引，全表扫描。先找到id=1的行，加<code>next-key</code>锁，发现name的值不匹配，继续向右查找，给id=3的行上锁，name匹配，返回结果给server层，然后继续向右查找直到最后一行id=11，查找过程中涉及到的行都被加了<code>next-key</code>锁(id=5,7,9,11的行)，由于事务没有提交，这些行锁没有被释放。</p>
<h3 id="SessionB被阻塞在哪里"><a href="#SessionB被阻塞在哪里" class="headerlink" title="SessionB被阻塞在哪里"></a>SessionB被阻塞在哪里</h3><p>更新条件 <code>where name=&#39;d005&#39;</code>，由于name列没有索引，查询时也要走主键索引。先找到id=1的行，加<code>next-key</code>锁，由于SessionA已经加了<code>next-key</code>锁，SessionB只能等待，它在此时发生了阻塞</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">update</span> t <span class="token keyword">set</span> age<span class="token operator">=</span><span class="token number">31</span> <span class="token keyword">where</span> name<span class="token operator">=</span><span class="token string">'d005'</span>
<span class="token comment"># 被SessionA上的 id=1的行的 next-key锁阻塞</span>
RECORD LOCKS space id <span class="token number">5</span> page <span class="token keyword">no</span> <span class="token number">4</span> n bits <span class="token number">80</span> <span class="token keyword">index</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token punctuation">`</span>t<span class="token punctuation">`</span>
trx id <span class="token number">4366</span> lock_mode X waiting
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>
 <span class="token number">1</span>: len <span class="token number">6</span><span class="token punctuation">;</span> hex <span class="token number">000000000</span>d98<span class="token punctuation">;</span> <span class="token keyword">asc</span>
 <span class="token number">2</span>: len <span class="token number">7</span><span class="token punctuation">;</span> hex <span class="token number">81000000</span>a70110<span class="token punctuation">;</span> <span class="token keyword">asc</span>
 <span class="token number">3</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">64303031</span><span class="token punctuation">;</span> <span class="token keyword">asc</span> d001
 <span class="token number">4</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">8000001</span>e<span class="token punctuation">;</span> <span class="token keyword">asc</span>
 <span class="token number">5</span>: len <span class="token number">1</span><span class="token punctuation">;</span> hex <span class="token number">81</span><span class="token punctuation">;</span> <span class="token keyword">asc</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>通过Id=5更新也会被SessinA的<code>next-key</code>锁阻塞，虽然SessionB加要的是<code>行锁</code>，这也从则面说明了<code>next-key</code>是由<code>行锁</code>和<code>间隙锁</code>组成</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">update</span> t <span class="token keyword">set</span> age<span class="token operator">=</span><span class="token number">31</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">5</span>
<span class="token comment"># 被id=5的记录上行锁阻塞</span>
RECORD LOCKS space id <span class="token number">5</span> page <span class="token keyword">no</span> <span class="token number">4</span> n bits <span class="token number">80</span> <span class="token keyword">index</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token punctuation">`</span>t<span class="token punctuation">`</span>
trx id <span class="token number">4367</span> lock_mode X locks rec but <span class="token operator">not</span> gap waiting
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000005</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>
 <span class="token number">1</span>: len <span class="token number">6</span><span class="token punctuation">;</span> hex <span class="token number">000000000</span>d9e<span class="token punctuation">;</span> <span class="token keyword">asc</span>
 <span class="token number">2</span>: len <span class="token number">7</span><span class="token punctuation">;</span> hex <span class="token number">82000000</span>a80110<span class="token punctuation">;</span> <span class="token keyword">asc</span>
 <span class="token number">3</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">64303034</span><span class="token punctuation">;</span> <span class="token keyword">asc</span> d004
 <span class="token number">4</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">8000001</span>e<span class="token punctuation">;</span> <span class="token keyword">asc</span>
 <span class="token number">5</span>: len <span class="token number">1</span><span class="token punctuation">;</span> hex <span class="token number">81</span><span class="token punctuation">;</span> <span class="token keyword">asc</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>插入数据也被阻塞，因为插入Id的值都落在了<code>间隙锁</code>[infimum，supremum]内，无法插入任何的值。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'d002'</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 插入id=2的值，被间隙锁(1,3)阻塞</span>
RECORD LOCKS space id <span class="token number">5</span> page <span class="token keyword">no</span> <span class="token number">4</span> n bits <span class="token number">80</span> <span class="token keyword">index</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token punctuation">`</span>t<span class="token punctuation">`</span>
trx id <span class="token number">4365</span> lock_mode X locks gap before rec <span class="token keyword">insert</span> intention waiting
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000003</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>
 <span class="token number">1</span>: len <span class="token number">6</span><span class="token punctuation">;</span> hex <span class="token number">000000001106</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>
 <span class="token number">2</span>: len <span class="token number">7</span><span class="token punctuation">;</span> hex <span class="token number">01000001120488</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>
 <span class="token number">3</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">64303033</span><span class="token punctuation">;</span> <span class="token keyword">asc</span> d003
 <span class="token number">4</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">8000001</span>f<span class="token punctuation">;</span> <span class="token keyword">asc</span>
 <span class="token number">5</span>: len <span class="token number">1</span><span class="token punctuation">;</span> hex <span class="token number">81</span><span class="token punctuation">;</span> <span class="token keyword">asc</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="加入limit减少被锁的行"><a href="#加入limit减少被锁的行" class="headerlink" title="加入limit减少被锁的行"></a>加入<code>limit</code>减少被锁的行</h2><table>
<thead>
<tr>
<th>时刻</th>
<th>Session A</th>
<th>Session B</th>
</tr>
</thead>
<tbody><tr>
<td>T1</td>
<td>begin;</td>
<td></td>
</tr>
<tr>
<td>T2</td>
<td>update t set age=31 where name=’d003’ limit 1;</td>
<td></td>
</tr>
<tr>
<td>T3</td>
<td></td>
<td>begin;</td>
</tr>
<tr>
<td>T4</td>
<td></td>
<td>update t set age=31 where name=’d005’;<font color=red>(blocked)</font></td>
</tr>
<tr>
<td></td>
<td></td>
<td>insert into t values(2,’d002’,30,1);<font color=red>(blocked)</font></td>
</tr>
<tr>
<td>T5</td>
<td></td>
<td>insert into t values(4,’d004’,30,1);<font color=green>(Query Ok)</font></td>
</tr>
</tbody></table>
<h3 id="SessionA加锁的范围是怎么样的"><a href="#SessionA加锁的范围是怎么样的" class="headerlink" title="SessionA加锁的范围是怎么样的"></a>SessionA加锁的范围是怎么样的</h3><p>主键索引<code>id</code>锁的范围是[infimum，3]</p>
<p>由于name列没有索引，查询时走主键索引，全表扫描。先找到id=1的行，加<code>next-key</code>锁，发现name的值不匹配，继续向右查找，给id=3的行上锁，name匹配，返回结果给server层，由于使用了<code>limit 1</code>，满足条件，不再向后查找，查询结束。记录(id:1),(id:3)的行上了<code>next-key</code>锁，之后的记录没有上锁。</p>
<h3 id="SessionB被阻塞在哪里-1"><a href="#SessionB被阻塞在哪里-1" class="headerlink" title="SessionB被阻塞在哪里"></a>SessionB被阻塞在哪里</h3><p>更新条件 <code>where name=&#39;d005&#39;</code>，由于name列没有索引，查询时也要走主键索引。先找到id=1的行，加<code>next-key</code>锁，由于SessionA已经加了<code>next-key</code>锁，SessionB只能等待，它在此时发生了阻塞</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">update</span> t <span class="token keyword">set</span> age<span class="token operator">=</span><span class="token number">31</span> <span class="token keyword">where</span> name<span class="token operator">=</span><span class="token string">'d005'</span>
<span class="token comment"># 被SessionA上的 id=1的行的 next-key锁阻塞</span>
RECORD LOCKS space id <span class="token number">5</span> page <span class="token keyword">no</span> <span class="token number">4</span> n bits <span class="token number">80</span> <span class="token keyword">index</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token punctuation">`</span>t<span class="token punctuation">`</span> 
trx id <span class="token number">4871</span> lock_mode X waiting
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>
 <span class="token number">1</span>: len <span class="token number">6</span><span class="token punctuation">;</span> hex <span class="token number">000000000</span>d98<span class="token punctuation">;</span> <span class="token keyword">asc</span>
 <span class="token number">2</span>: len <span class="token number">7</span><span class="token punctuation">;</span> hex <span class="token number">81000000</span>a70110<span class="token punctuation">;</span> <span class="token keyword">asc</span>
 <span class="token number">3</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">64303031</span><span class="token punctuation">;</span> <span class="token keyword">asc</span> d001
 <span class="token number">4</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">8000001</span>e<span class="token punctuation">;</span> <span class="token keyword">asc</span>
 <span class="token number">5</span>: len <span class="token number">1</span><span class="token punctuation">;</span> hex <span class="token number">81</span><span class="token punctuation">;</span> <span class="token keyword">asc</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>因为<code>id</code>锁的范围是[infimum，3]，(id=5,7,9,11)的行没有被上锁，可以更新及插入id &gt; 3的数据。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># Session B</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'d004'</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span>Query Ok<span class="token punctuation">)</span>

<span class="token comment"># 虽然不能通过 where name='d005' 修改</span>
<span class="token comment"># 但可以通过where id=5 修改，也说明了id=5的行没有被锁</span>
<span class="token comment"># 同时也绕过了需要等待id=1的锁的限制</span>
<span class="token keyword">update</span> t <span class="token keyword">set</span> age<span class="token operator">=</span><span class="token number">31</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span>Query Ok<span class="token punctuation">)</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+------+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name <span class="token operator">|</span> age  <span class="token operator">|</span> ismale <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> d001 <span class="token operator">|</span>   <span class="token number">30</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> d003 <span class="token operator">|</span>   <span class="token number">30</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> d004 <span class="token operator">|</span>   <span class="token number">30</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span> d005 <span class="token operator">|</span>   <span class="token number">31</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">7</span> <span class="token operator">|</span> d007 <span class="token operator">|</span>   <span class="token number">30</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">9</span> <span class="token operator">|</span> d009 <span class="token operator">|</span>   <span class="token number">30</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">11</span> <span class="token operator">|</span> d011 <span class="token operator">|</span>   <span class="token number">30</span> <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+--------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/mysql-deadlock/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
      <meta itemprop="description" content="雅思, 四级, 六级, 英语, 后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 睡月花儿">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/mysql-deadlock/" class="post-title-link" itemprop="url">mysql 死锁</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-08-25 13:10:32" itemprop="dateCreated datePublished" datetime="2021-08-25T13:10:32+00:00">2021-08-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="死锁的发生"><a href="#死锁的发生" class="headerlink" title="死锁的发生"></a>死锁的发生</h1><p>不同线程出现资源的循环依赖，都在等待对方释放自己所需要的资源，就会导致这几个线程进行无限等待的状态，发生死锁。</p>
<table>
<thead>
<tr>
<th>事务A</th>
<th>事务B</th>
</tr>
</thead>
<tbody><tr>
<td>Begin;</td>
<td>Begin;</td>
</tr>
<tr>
<td>update t set k=k+1 where id = 1;</td>
<td></td>
</tr>
<tr>
<td></td>
<td>update t set k=k+1 where id = 2;</td>
</tr>
<tr>
<td>update t set k=k+1 where id = 2;(block)</td>
<td></td>
</tr>
<tr>
<td></td>
<td>update t set k=k+1 where id = 1;<br><font color=red><br>&lt;ERROR 1213 (40001): <br>Deadlock found when trying to get lock;<br> try restarting transaction</font></td>
</tr>
<tr>
<td><font color=green>Query OK, 1 row affected (6.99 sec)<br>Rows matched: 1  Changed: 1  Warnings: 0</font></td>
<td></td>
</tr>
</tbody></table>
<p>事务A在等待事物B释放 id=2的行锁，而事务B在等待事物A释放id=1的行锁，双方都在等待对方释放资源，就发生了死锁。由于MySQL有死锁检测，会马上发现这个死锁，并对事务B进行回滚。</p>
<p>发生死锁的线程都是要锁至少2行(参与的有2个资源，一个资源是自己已经加锁，但别人也要加，另一个资源是别人已经加锁，但自己也要加)。如果一个事务只锁一行是不会发生死锁的，只会发生锁阻塞。</p>
<h2 id="应对策略"><a href="#应对策略" class="headerlink" title="应对策略"></a>应对策略</h2><ul>
<li><p>什么都不做，直接等到超时</p>
<p>上面的事务B，会发生超时。</p>
<p>通过设置<code>innodb_lock_wait_timeout</code>来指定超时时间，默认值是50s</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%innodb_lock_wait_timeout%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------------------+-------+</span>
<span class="token operator">|</span> Variable_name            <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------+-------+</span>
<span class="token operator">|</span> innodb_lock_wait_timeout <span class="token operator">|</span> <span class="token number">50</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------+-------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>进行死锁检测</p>
<p>开启死锁检测功能，检测到死锁后，对回滚成本比较低的事务进行回滚，让其它事务继续执行。设置参数<code>innodb_deadlock_detect</code>为on，开启此功能(默认为开启)</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">+</span><span class="token comment">------------------------+-------+</span>
<span class="token operator">|</span> Variable_name          <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------+-------+</span>
<span class="token operator">|</span> innodb_deadlock_detect <span class="token operator">|</span> <span class="token keyword">ON</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------+-------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h2 id="哪种策略更好"><a href="#哪种策略更好" class="headerlink" title="哪种策略更好"></a>哪种策略更好</h2><ul>
<li><p>缩短等待的超时时间</p>
<p><code>innodb_lock_wait_timeout</code>的默认等待为50秒，对于生产环境，这显然是无法接受的。如果设置为1秒呢，虽然等待的时间变短，但也会误伤那些只是等待锁，而不是陷入死锁的线程。比如2秒以后就可以拿到锁的那些线程。</p>
</li>
<li><p>启用死锁检测</p>
<p>MySql默认启用死锁检测，当发现加入进来的线程会产生死锁时，会回滚成本较低的事务。MySQL发现死锁的速度很快，所以推荐使用死锁检测</p>
</li>
<li><p>关闭死锁检测</p>
<p>如果可以确定所有的SQL不会产生死锁问题，可以关闭死锁检测。死锁检测虽然好使，但也是有代价的，会占用CPU的资源。</p>
</li>
</ul>
<h1 id="死锁检测的成本"><a href="#死锁检测的成本" class="headerlink" title="死锁检测的成本"></a>死锁检测的成本</h1><p>当一个线程新加入到某个资源的阻塞队列时，会检测它的加入是否与其它正在发生阻塞的线程存在资源的相互依赖，从而导致死锁的发生。如果这是一个高并发的资源，阻塞队列里有大量排队的线程，那么每个线程都要把其它线程检查一遍，每个线程要检查的时间复杂度就是<code>O(N)</code>。</p>
<p>比如有1000个并发线程，那么要总共要检测的数量就是 1000 * 1000 = 100W，即<code>O(N^2)</code>，这种数量级的检测就会导致消耗大量的CPU资源，你看到的现象就是CPU占用率很高，却处理不了多少事务，或是你发现理处的事务很少，但CPU占用率却很高。</p>
<h1 id="控制并发度"><a href="#控制并发度" class="headerlink" title="控制并发度"></a>控制并发度</h1><p>要想从根本上减少死锁及锁等待，就要降低对同一资源的并发访问数量</p>
<p>可以使用的方法</p>
<ul>
<li><p>分摊热点资源的访问量</p>
<p>比如参加秒杀的商品，它的库存如果存放在一条记录中，那么在高并发下，比如有1000个请求，就会同时更新，这样就会导致线程的阻塞或发生死锁。</p>
<p>可以把保存库存的记录一条拆成N条，让请求随机访问这N条记录，比如分别放在100个记录中，那么每个记录最多只有10个更新请求，这样可以把并发量降为原来的<code>1/N</code>，大大减小了死锁的发生和锁的等待， 以及死锁检测的成本</p>
</li>
<li><p>把并发请求放入队列</p>
<p>数据库中间件可以把请求放入队列，使并发请求变为顺序访问</p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/mysql-sequence-of-sql-in-trx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
      <meta itemprop="description" content="雅思, 四级, 六级, 英语, 后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 睡月花儿">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/mysql-sequence-of-sql-in-trx/" class="post-title-link" itemprop="url">mysql 事务中多条SQL的排序</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-08-18 16:00:31" itemprop="dateCreated datePublished" datetime="2021-08-18T16:00:31+00:00">2021-08-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>场景：用户购买商品A，对应的SQL如下</p>
<ol>
<li>商品A库存减1 (SQL1)</li>
<li>用户购买商品A，扣减用户金额 (SQL2)</li>
<li>插入一条交易日志 (SQL3)</li>
</ol>
<p>这三个操作为原子操作，所以要写在一个事务中。如果有大量用户购买商品A，则<code>商品A库存减1 </code>为热点数据，被频繁更新。假设每条SQL的执行时间为5秒，则整个事务的执行时间为15秒，由于有大量用户购买，那么不同的执行顺序将会影响最终的执行时间，从而影响并发</p>
<p>把<code>商品A库存减1 (SQL1)</code>放在首行(情况1)</p>
<table>
<thead>
<tr>
<th>时刻</th>
<th>事务A</th>
<th>事务B</th>
<th>耗时</th>
</tr>
</thead>
<tbody><tr>
<td>T1</td>
<td>商品A库存减1 (SQL1)</td>
<td>商品A库存减1 (SQL1) 发生等待，不能执行，直到  T4 时刻</td>
<td>5s</td>
</tr>
<tr>
<td>T2</td>
<td>用户购买商品A，扣减用户金额 (SQL2)</td>
<td></td>
<td>5s</td>
</tr>
<tr>
<td>T3</td>
<td>插入一条交易日志 (SQL3)</td>
<td></td>
<td>5s</td>
</tr>
<tr>
<td>T4</td>
<td></td>
<td>商品A库存减1 (SQL1)</td>
<td>5s</td>
</tr>
<tr>
<td>T5</td>
<td></td>
<td>用户购买商品A，扣减用户金额 (SQL2)</td>
<td>5s</td>
</tr>
<tr>
<td>T6</td>
<td></td>
<td>插入一条交易日志 (SQL3)</td>
<td>5s</td>
</tr>
</tbody></table>
<ul>
<li>T1时刻，事务A执行<code>商品A库存减1</code>，给其上锁，直到事务提交（15秒以后）</li>
<li>同时事务B也执行<code>商品A库存减1</code>，被阻塞，发生锁等待，这使得后面的<code>Sql2,sql2</code>语句不能执行，直到15s后，事务A提交数据。 即T4时刻才开始执行。</li>
<li>事务B总共耗时30秒才完成。等待事务A的15s(T1到T3) + 自身的15s</li>
</ul>
<p>如果把<code>商品A库存减1 (SQL1)</code>放在最后，可以减少等待的时间(情况2)</p>
<table>
<thead>
<tr>
<th>时刻</th>
<th>事务A</th>
<th>事务B</th>
<th>耗时</th>
</tr>
</thead>
<tbody><tr>
<td>T1</td>
<td>用户购买商品A，扣减用户金额 (SQL2)</td>
<td>用户购买商品A，扣减用户金额 (SQL2)</td>
<td>5s</td>
</tr>
<tr>
<td>T2</td>
<td>插入一条交易日志 (SQL3)</td>
<td>插入一条交易日志 (SQL3)</td>
<td>5s</td>
</tr>
<tr>
<td>T3</td>
<td>商品A库存减1 (SQL1)</td>
<td>商品A库存减1 (SQL1) 发生等待，不能执行，直到  T4 时刻</td>
<td>5s</td>
</tr>
<tr>
<td>T4</td>
<td></td>
<td>商品A库存减1 (SQL1)</td>
<td>5s</td>
</tr>
</tbody></table>
<ul>
<li>扣减用户金额是针对单个用户操作，在同一时刻更新这些记录不太容易发生锁等待，所以事务A与事务B在T1时刻可以同时进行</li>
<li>插入一条交易日志 也是可以同时进行的，所以事务A与事务B在T2时刻同时进行</li>
<li>事务A T3 时刻执行完成，耗时15s，事务B 在此时被阻塞，因为要更新同一条记录，发生了锁等待，需要等待5秒</li>
<li>事务B在T4时刻，执行完成，耗时 20s（10s + 等待 5s + 5s）</li>
</ul>
<p>当把<code>商品A库存减1 (SQL1)</code>放在最后时，事务B的执行时间缩短到了20s，节省了10s，大大提高了并发度。</p>
<p>可以看出，锁等待时间是正在执行的事物引起锁的语句到提交的时间间隔，如果放在事务最后，那这个时间间隔会变为最少。对照上面的例子，情况1事务A从T1到T3时刻，持有锁总共15s。情况2，事务A只在T3时刻持有锁，总共5s，可见把<code>商品A库存减1 (SQL1)</code>放到最后时，大大减少了时间间隔。</p>
<p>通过减少事务持有锁的时间，大程度的减少了事务之间的锁等待，提高了并发度。所以通常的做法是把热点更新语句放到事务的最后，这样当事务结束后，热点语句的锁可以被马上释放，减少事务锁持有的时间，其它事务等待锁释放的时间就会变短，从而使并发度得到了提高。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/golang-pprof/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
      <meta itemprop="description" content="雅思, 四级, 六级, 英语, 后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 睡月花儿">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/golang-pprof/" class="post-title-link" itemprop="url">go 语言 程序性能剖析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-08-15 14:59:46" itemprop="dateCreated datePublished" datetime="2021-08-15T14:59:46+00:00">2021-08-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/golang/" itemprop="url" rel="index"><span itemprop="name">golang</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h1><p>对程序性能进行剖析，可以找到性能的瓶颈、bug、以及对程序进行有目标的优化，从而提高程序的性能，解决程序中存在的问题。</p>
<h1 id="如何对程序进行剖析"><a href="#如何对程序进行剖析" class="headerlink" title="如何对程序进行剖析"></a>如何对程序进行剖析</h1><ol>
<li>设置要分析的指标，利用<code>工具 (go test)</code>或<code>性能指标API</code>对指标进行剖析，生成对应的概要文件(二进制文件)</li>
<li>使用分析工具(go tool pprof/ go tool trace)对概要文件进行解析，得到性能指标值的具体信息，这些信息可以以文本，图形的形式展示。</li>
<li>根据得到性能指标值的具体信息，分析程序性能，查找程序瓶颈或对程序进行优化</li>
</ol>
<p>要对一个程序进行剖析，必须先生成对应指标的<code>概要文件</code>，然后再用<code>分析工具</code>去解析这个<code>概要文件</code></p>
<h1 id="概要文件"><a href="#概要文件" class="headerlink" title="概要文件"></a>概要文件</h1><p>是Go程序在某一段时间内，对相关指标采样后，得到的概要信息。剖析时，会在程序执行期间进行一些自动抽样，在结束时进行推断，最后把统计结果保存为概要文件，供分析工具使用。</p>
<h2 id="概要文件的格式"><a href="#概要文件的格式" class="headerlink" title="概要文件的格式"></a>概要文件的格式</h2><p>概要文件其实就是 由 <code>protocol buffers</code> 生成的二进制数据流，<code>protocol buffers</code> 是一种数据序列化协议，它定义了程序对象如 <code>map</code>，结构体，数组等与字节之间如何相互转化。同时 <code>protocol buffers</code> 不仅仅是协议，也可以作为转化工具来使用，它可以把字节流转化为对象，也可以把对象转化为字节流。<code>protocol buffers</code> 会对生成的字节流进行压缩，它的体积比(<code>JSON，XML</code>)都要更小，所以也更适合用于数据在网上传输</p>
<h2 id="生成概要文件的方法"><a href="#生成概要文件的方法" class="headerlink" title="生成概要文件的方法"></a>生成概要文件的方法</h2><p>Go 语言支持多种类型的性能分析，可以通过</p>
<ul>
<li>使用 go test 配合对应的标识符</li>
<li>使用性能指标API</li>
</ul>
<p>这两种方式，都可以生成概要文件</p>
<h2 id="有关性能的概要文件"><a href="#有关性能的概要文件" class="headerlink" title="有关性能的概要文件"></a>有关性能的概要文件</h2><p>CPU概要文件，内存概要文件，阻塞概要文件，它们可以通过 go test 配合对应的标识符生成，对CPU，内存，阻塞这三个指标进行分析。</p>
<h1 id="Go-test-标识生成概要文件"><a href="#Go-test-标识生成概要文件" class="headerlink" title="Go test 标识生成概要文件"></a>Go test 标识生成概要文件</h1><p>可以使用 <code>go test</code>工具提供的剖析标识对程序进行分析，生成概要文件。不要让多个剖析标识同时运行，它们之间会相互影响，导致分析结果不准确</p>
<h2 id="Cpu-剖析标识"><a href="#Cpu-剖析标识" class="headerlink" title="Cpu 剖析标识"></a>Cpu 剖析标识</h2><p>记录占用CPU时间最长的函数，每个运行在CPU上的函数每几毫秒都会遇到系统中断事件，每次中断时，都会记录一个剖析数据</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> test gott<span class="token operator">/</span>fib <span class="token operator">-</span>cpuprofile<span class="token operator">=</span>cpu<span class="token punctuation">.</span>log <span class="token operator">-</span>run<span class="token operator">=</span>None <span class="token operator">-</span>bench<span class="token operator">=</span>FibWithMap<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h2 id="堆剖析标识"><a href="#堆剖析标识" class="headerlink" title="堆剖析标识"></a>堆剖析标识</h2><p>记录最耗内容的语句，平均每申请512K的内存，就会记录一个剖析数据</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> test gott<span class="token operator">/</span>fib <span class="token operator">-</span>memprofile<span class="token operator">=</span>mem<span class="token punctuation">.</span>log <span class="token operator">-</span>run<span class="token operator">=</span>None <span class="token operator">-</span>bench<span class="token operator">=</span>FibWithMap<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h2 id="阻塞剖解标识"><a href="#阻塞剖解标识" class="headerlink" title="阻塞剖解标识"></a>阻塞剖解标识</h2><p>记录阻塞goroutine最久的操作，如系统调用，等待锁，管道收发等，每当这些操作阻塞goroutine时，就会记录一个剖析数据</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> test gott<span class="token operator">/</span>fib <span class="token operator">-</span>blockprofile<span class="token operator">=</span>block<span class="token punctuation">.</span>log <span class="token operator">-</span>run<span class="token operator">=</span>None <span class="token operator">-</span>bench<span class="token operator">=</span>FibWithMap<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h1 id="解析概要文件"><a href="#解析概要文件" class="headerlink" title="解析概要文件"></a>解析概要文件</h1><h2 id="可执行文件"><a href="#可执行文件" class="headerlink" title="可执行文件"></a>可执行文件</h2><p>使用以上标识符，除了生成了剖析数据日志(cpu.log/mem.log/block.log)，go test  还会生成对应的可执行程序(fib.test)，以包名做为前缀，后面为<code>.test</code>的文件。为了减少剖析数据日志占用的空间和提高分析效率，分析日志本身并没有记录函数的名称，而是函数的地址，所以需要与之对应的可执行文件，才可以对剖析日志进行数据分析</p>
<h2 id="pprof-分析工具"><a href="#pprof-分析工具" class="headerlink" title="pprof 分析工具"></a>pprof 分析工具</h2><p> <code>go tool pprof</code>命令可以用来分析剖析日志，它需要两个基本的参数</p>
<ul>
<li>剖析文件日志</li>
<li>测试生成的可执行文件</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> tool pprof <span class="token operator">-</span>text <span class="token operator">-</span>nodecount<span class="token operator">=</span><span class="token number">10</span> <span class="token punctuation">.</span><span class="token operator">/</span>fib<span class="token punctuation">.</span>test cpu<span class="token punctuation">.</span>log

File<span class="token punctuation">:</span> fib<span class="token punctuation">.</span>test
Type<span class="token punctuation">:</span> cpu
Time<span class="token punctuation">:</span> Aug <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">2021</span> at <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">30</span>am <span class="token punctuation">(</span>CST<span class="token punctuation">)</span>
Duration<span class="token punctuation">:</span> <span class="token number">1.43</span>s<span class="token punctuation">,</span> Total samples <span class="token operator">=</span> <span class="token number">1.09</span>s <span class="token punctuation">(</span><span class="token number">76.02</span><span class="token operator">%</span><span class="token punctuation">)</span>
Showing nodes accounting <span class="token keyword">for</span> <span class="token number">1.09</span>s<span class="token punctuation">,</span> <span class="token number">100</span><span class="token operator">%</span> of <span class="token number">1.09</span>s total
Showing top <span class="token number">10</span> nodes out of <span class="token number">17</span>
      flat  flat<span class="token operator">%</span>   sum<span class="token operator">%</span>        cum   cum<span class="token operator">%</span>
     <span class="token number">0.49</span>s <span class="token number">44.95</span><span class="token operator">%</span> <span class="token number">44.95</span><span class="token operator">%</span>      <span class="token number">0.94</span>s <span class="token number">86.24</span><span class="token operator">%</span>  runtime<span class="token punctuation">.</span>mapaccess2_fast64
     <span class="token number">0.36</span>s <span class="token number">33.03</span><span class="token operator">%</span> <span class="token number">77.98</span><span class="token operator">%</span>      <span class="token number">0.36</span>s <span class="token number">33.03</span><span class="token operator">%</span>  runtime<span class="token punctuation">.</span>memhash64
     <span class="token number">0.12</span>s <span class="token number">11.01</span><span class="token operator">%</span> <span class="token number">88.99</span><span class="token operator">%</span>      <span class="token number">1.06</span>s <span class="token number">97.25</span><span class="token operator">%</span>  gott<span class="token operator">/</span>fib<span class="token punctuation">.</span>fibWithMap
     <span class="token number">0.06</span>s  <span class="token number">5.50</span><span class="token operator">%</span> <span class="token number">94.50</span><span class="token operator">%</span>      <span class="token number">0.06</span>s  <span class="token number">5.50</span><span class="token operator">%</span>  runtime<span class="token punctuation">.</span>add <span class="token punctuation">(</span>partial<span class="token operator">-</span>inline<span class="token punctuation">)</span>
     <span class="token number">0.03</span>s  <span class="token number">2.75</span><span class="token operator">%</span> <span class="token number">97.25</span><span class="token operator">%</span>      <span class="token number">0.03</span>s  <span class="token number">2.75</span><span class="token operator">%</span>  runtime<span class="token punctuation">.</span>bucketShift <span class="token punctuation">(</span>inline<span class="token punctuation">)</span>
     <span class="token number">0.02</span>s  <span class="token number">1.83</span><span class="token operator">%</span> <span class="token number">99.08</span><span class="token operator">%</span>      <span class="token number">1.08</span>s <span class="token number">99.08</span><span class="token operator">%</span>  gott<span class="token operator">/</span>fib<span class="token punctuation">.</span>BenchmarkFibWithMap
     <span class="token number">0.01</span>s  <span class="token number">0.92</span><span class="token operator">%</span>   <span class="token number">100</span><span class="token operator">%</span>      <span class="token number">0.01</span>s  <span class="token number">0.92</span><span class="token operator">%</span>  runtime<span class="token punctuation">.</span>wbBufFlush1
         <span class="token number">0</span>     <span class="token number">0</span><span class="token operator">%</span>   <span class="token number">100</span><span class="token operator">%</span>      <span class="token number">0.01</span>s  <span class="token number">0.92</span><span class="token operator">%</span>  runtime<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">.</span>overflow <span class="token punctuation">(</span>inline<span class="token punctuation">)</span>
         <span class="token number">0</span>     <span class="token number">0</span><span class="token operator">%</span>   <span class="token number">100</span><span class="token operator">%</span>      <span class="token number">0.03</span>s  <span class="token number">2.75</span><span class="token operator">%</span>  runtime<span class="token punctuation">.</span>bucketMask <span class="token punctuation">(</span>inline<span class="token punctuation">)</span>
         <span class="token number">0</span>     <span class="token number">0</span><span class="token operator">%</span>   <span class="token number">100</span><span class="token operator">%</span>      <span class="token number">0.01</span>s  <span class="token number">0.92</span><span class="token operator">%</span>  runtime<span class="token punctuation">.</span>findrunnable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>./fib.test</code>：测试生成的可执行文件，在一般的测试中，当测试完成后，文件就会被丢弃，但在启用剖析标识后，这个文件会被保留，供之后的分析使用</li>
<li><code> -nodecount</code>：限制分析结果输出的行数</li>
<li><code>-text</code>：指定输出的格式</li>
</ul>
<p>还可以使用-web选项，用于生成函数的有向图，标注有CPU的使用和最热点的函数等信息</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> tool pprof <span class="token operator">-</span>web <span class="token operator">-</span>nodecount<span class="token operator">=</span><span class="token number">10</span> <span class="token punctuation">.</span><span class="token operator">/</span>fib<span class="token punctuation">.</span>test cpu<span class="token punctuation">.</span>log

<span class="token comment">// 使用-web需要安装 GraphViz</span>
brew install graphviz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<p>还可以不加任何选项进入交互界面</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> tool pprof cpu<span class="token punctuation">.</span>log
Type<span class="token punctuation">:</span> cpu
Time<span class="token punctuation">:</span> Aug <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">2021</span> at <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">30</span>am <span class="token punctuation">(</span>CST<span class="token punctuation">)</span>
Duration<span class="token punctuation">:</span> <span class="token number">1.43</span>s<span class="token punctuation">,</span> Total samples <span class="token operator">=</span> <span class="token number">1.09</span>s <span class="token punctuation">(</span><span class="token number">76.02</span><span class="token operator">%</span><span class="token punctuation">)</span>
Entering interactive mode <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token string">"help"</span> <span class="token keyword">for</span> commands<span class="token punctuation">,</span> <span class="token string">"o"</span> <span class="token keyword">for</span> options<span class="token punctuation">)</span>
<span class="token punctuation">(</span>pprof<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里只用到了概要文件，没有用到测试生成的可执行文件</p>
<h1 id="性能指标API生成概要文件"><a href="#性能指标API生成概要文件" class="headerlink" title="性能指标API生成概要文件"></a>性能指标API生成概要文件</h1><p>除了使用 go test 标识对程序进行性能分析，还可以使用标准库中的 <code>runtime/pprof</code>，<code>runtime/trace</code>，<code>net/http/pprof</code>这三个包中提供的API来对Go程序进行性能分析，生成概要文件。</p>
<h2 id="生成CPU概要文件"><a href="#生成CPU概要文件" class="headerlink" title="生成CPU概要文件"></a>生成CPU概要文件</h2><h3 id="StartCPUProfile函数"><a href="#StartCPUProfile函数" class="headerlink" title="StartCPUProfile函数"></a>StartCPUProfile函数</h3><p><code>StartCPUProfile()</code>函数对CPU信息进行定时采样生成概要文件，默认采样频率是100Hz，即每秒采样100次，调用<code>pprof.StartCPUProfile()</code>函数开始进行采样。</p>
<h3 id="StopCPUProfile函数"><a href="#StopCPUProfile函数" class="headerlink" title="StopCPUProfile函数"></a>StopCPUProfile函数</h3><p>调用<code>pprof.StopCPUProfile()</code>停止采样。当调用<code>pprof.StartCPUProfile()</code>时，会启用一个新的goroutine，并在其中进行CPU信息的收集</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">StopCPUProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	cpu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> cpu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> <span class="token operator">!</span>cpu<span class="token punctuation">.</span>profiling <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	cpu<span class="token punctuation">.</span>profiling <span class="token operator">=</span> <span class="token boolean">false</span>
	runtime<span class="token punctuation">.</span><span class="token function">SetCPUProfileRate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>cpu<span class="token punctuation">.</span>done
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>StopCPUProfile</code>是通过设置<code>SetCPUProfileRate(0)</code>为0，来停止采样的，而<code>pprof.StartCPUProfile</code> 是把<code>runtime.SetCPUProfileRate(100)</code>设置为100来开始采样的</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	profileName <span class="token operator">:=</span> <span class="token string">"cpu_api.log"</span>
	f<span class="token punctuation">,</span> err <span class="token operator">:=</span> common<span class="token punctuation">.</span><span class="token function">CreateFile</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> profileName<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"CPU profile creation error: %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	pprof<span class="token punctuation">.</span><span class="token function">StartCPUProfile</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
	op<span class="token punctuation">.</span><span class="token function">CPULoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 耗时的CPU操作</span>
	pprof<span class="token punctuation">.</span><span class="token function">StopCPUProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>pprof.StartCPUProfile(f)</code>：把概要文件写入 cpu_api.log 文件</p>
<p>生成概要文件</p>
<p><code>go run pprof/cpu/cpu.go</code></p>
<p>go tool pprof 查看概要文件内容</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go tool pprof -text -nodecount<span class="token operator">=</span><span class="token number">15</span>  cpu_api.log
Type: cpu
Time: Aug <span class="token number">17</span>, <span class="token number">2021</span> at <span class="token number">3</span>:56pm <span class="token punctuation">(</span>CST<span class="token punctuation">)</span>
Duration: <span class="token number">1</span>.62s, Total samples <span class="token operator">=</span> <span class="token number">1</span>.47s <span class="token punctuation">(</span><span class="token number">90.66</span>%<span class="token punctuation">)</span>
Showing nodes accounting <span class="token keyword">for</span> <span class="token number">1</span>.47s, <span class="token number">100</span>% of <span class="token number">1</span>.47s total
Showing <span class="token function">top</span> <span class="token number">15</span> nodes out of <span class="token number">49</span>
      flat  flat%   sum%        cum   cum%
     <span class="token number">1</span>.29s <span class="token number">87.76</span>% <span class="token number">87.76</span>%      <span class="token number">1</span>.29s <span class="token number">87.76</span>%  runtime.memmove
     <span class="token number">0</span>.06s  <span class="token number">4.08</span>% <span class="token number">91.84</span>%      <span class="token number">0</span>.06s  <span class="token number">4.08</span>%  runtime.usleep
     <span class="token number">0</span>.02s  <span class="token number">1.36</span>% <span class="token number">93.20</span>%      <span class="token number">0</span>.02s  <span class="token number">1.36</span>%  runtime.madvise
     <span class="token number">0</span>.02s  <span class="token number">1.36</span>% <span class="token number">94.56</span>%      <span class="token number">0</span>.02s  <span class="token number">1.36</span>%  runtime.pthread_kill
     <span class="token number">0</span>.02s  <span class="token number">1.36</span>% <span class="token number">95.92</span>%      <span class="token number">0</span>.10s  <span class="token number">6.80</span>%  runtime.slicebytetostring
     <span class="token number">0</span>.01s  <span class="token number">0.68</span>% <span class="token number">96.60</span>%      <span class="token number">1</span>.25s <span class="token number">85.03</span>%  bytes.<span class="token punctuation">(</span>*Buffer<span class="token punctuation">)</span>.WriteString
     <span class="token number">0</span>.01s  <span class="token number">0.68</span>% <span class="token number">97.28</span>%      <span class="token number">0</span>.01s  <span class="token number">0.68</span>%  runtime.<span class="token punctuation">(</span>*mspan<span class="token punctuation">)</span>.init <span class="token punctuation">(</span>inline<span class="token punctuation">)</span>
     <span class="token number">0</span>.01s  <span class="token number">0.68</span>% <span class="token number">97.96</span>%      <span class="token number">0</span>.01s  <span class="token number">0.68</span>%  runtime.memclrNoHeapPointers
     <span class="token number">0</span>.01s  <span class="token number">0.68</span>% <span class="token number">98.64</span>%      <span class="token number">0</span>.01s  <span class="token number">0.68</span>%  runtime.newArenaMayUnlock
     <span class="token number">0</span>.01s  <span class="token number">0.68</span>% <span class="token number">99.32</span>%      <span class="token number">0</span>.01s  <span class="token number">0.68</span>%  runtime.pthread_cond_wait
     <span class="token number">0</span>.01s  <span class="token number">0.68</span>%   <span class="token number">100</span>%      <span class="token number">0</span>.05s  <span class="token number">3.40</span>%  strconv.FormatInt
         <span class="token number">0</span>     <span class="token number">0</span>%   <span class="token number">100</span>%      <span class="token number">0</span>.06s  <span class="token number">4.08</span>%  bytes.<span class="token punctuation">(</span>*Buffer<span class="token punctuation">)</span>.String <span class="token punctuation">(</span>inline<span class="token punctuation">)</span>
         <span class="token number">0</span>     <span class="token number">0</span>%   <span class="token number">100</span>%      <span class="token number">0</span>.10s  <span class="token number">6.80</span>%  bytes.<span class="token punctuation">(</span>*Buffer<span class="token punctuation">)</span>.grow
         <span class="token number">0</span>     <span class="token number">0</span>%   <span class="token number">100</span>%      <span class="token number">0</span>.01s  <span class="token number">0.68</span>%  bytes.makeSlice
         <span class="token number">0</span>     <span class="token number">0</span>%   <span class="token number">100</span>%      <span class="token number">1</span>.36s <span class="token number">92.52</span>%  gott/common/op.CPULoad<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h2 id="生成内存概要文件"><a href="#生成内存概要文件" class="headerlink" title="生成内存概要文件"></a>生成内存概要文件</h2><p>对堆内存的使用进行采样，会按照平均每分配多少个字节(默认为512B)，就对堆内存的使用情况进行一次采样。</p>
<h3 id="MemProfileRate"><a href="#MemProfileRate" class="headerlink" title="MemProfileRate"></a>MemProfileRate</h3><p>为 runtime.MemProfileRate 设置采样频率(默认值是512KB)，对其赋0值表示停止采样。</p>
<h3 id="WriteHeapProfile-函数"><a href="#WriteHeapProfile-函数" class="headerlink" title="WriteHeapProfile 函数"></a>WriteHeapProfile 函数</h3><p>调用WriteHeapProfile 函数，根据采样频率进行采样，并把收集到的采样信息写入指定文件。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 源码文件</span>
<span class="token comment">// WriteHeapProfile is shorthand for Lookup("heap").WriteTo(w, 0).</span>
<span class="token comment">// It is preserved for backwards compatibility.</span>
<span class="token keyword">func</span> <span class="token function">WriteHeapProfile</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token function">writeHeap</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="ReadMemStats-函数"><a href="#ReadMemStats-函数" class="headerlink" title="ReadMemStats 函数"></a>ReadMemStats 函数</h3><p><code>WriteHeapProfile(f)</code>函数记录的并不是实时的内存概要信息，而是最近一次内存垃圾工作完成后产生的。要得到实时信息可以使用<code>runtime.ReadMemStats()</code>函数</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	profileName <span class="token operator">:=</span> <span class="token string">"mem_api.log"</span>
	f<span class="token punctuation">,</span> err <span class="token operator">:=</span> common<span class="token punctuation">.</span><span class="token function">CreateFile</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> profileName<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"memory profile creation error: %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">startMemProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fib<span class="token punctuation">.</span><span class="token function">FibMap</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>
	<span class="token function">endMemProfile</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">startMemProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	runtime<span class="token punctuation">.</span>MemProfileRate <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">endMemProfile</span><span class="token punctuation">(</span>f <span class="token operator">*</span>os<span class="token punctuation">.</span>File<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	pprof<span class="token punctuation">.</span><span class="token function">WriteHeapProfile</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>调用<code>runtime.MemProfileRate</code>设置每申请1B的内存，就进行采样，调用<code>pprof.WriteHeapProfile(f)</code>把采样信息写入指定的文件<code>mem_api.log</code>中</p>
<h2 id="生成阻塞概要文件"><a href="#生成阻塞概要文件" class="headerlink" title="生成阻塞概要文件"></a>生成阻塞概要文件</h2><h3 id="SetBlockProfileRate函数"><a href="#SetBlockProfileRate函数" class="headerlink" title="SetBlockProfileRate函数"></a>SetBlockProfileRate函数</h3><p>它在<code>runtime</code>包中，用来设置采样频率，其参数<code>rate</code>的值表示，当阻塞持续多少纳秒后对其进行进行采样。如果这个值小于等于0，则停止采样。</p>
<h3 id="blockprofilerate变量"><a href="#blockprofilerate变量" class="headerlink" title="blockprofilerate变量"></a>blockprofilerate变量</h3><p>参数<code>rate</code>的值会被转换为CPU的时钟周期，然后赋值给<code>blockprofilerate</code>，即：实际采样频率为当一个阻塞持续了多少个CPU时钟周期，就对这个事件进行采样</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// go 源码文件</span>
<span class="token keyword">func</span> <span class="token function">SetBlockProfileRate</span><span class="token punctuation">(</span>rate <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> r <span class="token builtin">int64</span>
	<span class="token keyword">if</span> rate <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		r <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// disable profiling</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> rate <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">&#123;</span>
		r <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// profile everything</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// convert ns to cycles, use float64 to prevent overflow during multiplication</span>
		r <span class="token operator">=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>rate<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">float64</span><span class="token punctuation">(</span><span class="token function">tickspersecond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> r <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			r <span class="token operator">=</span> <span class="token number">1</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	atomic<span class="token punctuation">.</span><span class="token function">Store64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>blockprofilerate<span class="token punctuation">,</span> <span class="token function">uint64</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="pprof-Lookup-“block”"><a href="#pprof-Lookup-“block”" class="headerlink" title="pprof.Lookup(“block”)"></a>pprof.Lookup(“block”)</h3><p>用来获取阻塞概要信息，获取信息要调用<code>pprof.Lookup(&quot;block&quot;)</code>，<code>block</code>做为参数传入，函数会返回一个<code>*pprof.Profile</code>类型的值，对这个值调用<code>WriteTo(w io.Writer, debug int)</code>方法，可以把概要信息写入文件。这个方法的第一个参数传入要写入概要信息的文件，第二个参数debug表示概要信息详细程度</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	profileName <span class="token operator">:=</span> <span class="token string">"block_api.log"</span>
	f<span class="token punctuation">,</span> err <span class="token operator">:=</span> common<span class="token punctuation">.</span><span class="token function">CreateFile</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> profileName<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"block profile creation error: %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">startBlockProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fib<span class="token punctuation">.</span><span class="token function">FibMap</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span>
	<span class="token function">stopBlockProfile</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">startBlockProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	runtime<span class="token punctuation">.</span><span class="token function">SetBlockProfileRate</span><span class="token punctuation">(</span>blockProfileRate<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">stopBlockProfile</span><span class="token punctuation">(</span>f <span class="token operator">*</span>os<span class="token punctuation">.</span>File<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	pprof<span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token string">"block"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WriteTo</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> debug<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>debug参数的值</p>
<ul>
<li>0：生成protocol buffers字节流</li>
<li>1：生成内容可读的普通文本的概要文件，且函数名，包名，源码文件等信息会被做为注释加入进概要文件</li>
<li>2：生成内容可读的普通文本的概要文件，且包括更详细的信息</li>
</ul>
<p>对于使用参数值<code>1、2</code>生成的概要文件，不能使用 <code>go tool pprof </code> 查看，因为文件不是 <code>protocol</code>格式</p>
<h1 id="pprof-Lookup函数的使用"><a href="#pprof-Lookup函数的使用" class="headerlink" title="pprof.Lookup函数的使用"></a>pprof.Lookup函数的使用</h1><p><code>Lookup(name string)</code>通过给定的<code>name</code> 的值，返回对应的概要信息。如果返回值是 nil，表示不存在与给定名称对应的概要信息。预定义了6个概要名称，分别是<code>goroutine, threadcreate, heap, allocs, block, mutex</code></p>
<p>函数的返回值是<code>*Profile</code>类型的值，可以通过调用<code>WriteTo(w io.Writer, debug int)</code>方法，把采样的概要信息写入指定的文件中(通过第一个参数设置)，第二个参数表示了写入信息的详细细节程序，值可以是<code>0,1,2</code>(具体代表的内容就是上面小节讲的)。</p>
<p>预定义概要名称的使用</p>
<ul>
<li><p><code>goroutine</code></p>
<p>此指标可以收集正在使用的所有 goroutine 的堆栈跟踪信息，在调用WriteTo方法时，如果debug的值大于等于2，会把这些信息写入概要文件，文件可能会非常大</p>
</li>
<li><p><code>heap、allocs</code></p>
<p>此指标会收集与堆内存的分配和释放有关的采样信息，可以看成是内存概要信息，heap 与 allocs 仅在debug为0的时候会有区别，heap统计的是已经分配但还没有释放的内存空间，allocs展示的是已分配的内存空间。当debug的值大于0时，这两个指标值输出的内容是相同的</p>
</li>
<li><p><code>threadcreate</code></p>
<p>此指标会收集堆栈跟踪信息。这些堆栈跟踪信息中的每一个都会描绘出一个代码调用链，这些调用链上的代码都导致新的操作系统线程产生</p>
</li>
<li><p><code>block</code></p>
<p>此指标会收集因争用同步原语而被阻塞的那些代码的堆栈跟踪信息</p>
</li>
<li><p><code>mutex</code></p>
<p>此指标会收集曾经作为同步原语持有者的那些代码，它们的堆栈跟踪信息</p>
<p>同步原语可以理解为：通道、互斥锁、条件变量、”WaitGroup”</p>
</li>
</ul>
<p>对于除了 CPU 概要信息之外的其他概要信息，我们都可以通过调用这个函数获取到。</p>
<h1 id="为基于-HTTP-协议的网络服务添加性能分析接口"><a href="#为基于-HTTP-协议的网络服务添加性能分析接口" class="headerlink" title="为基于 HTTP 协议的网络服务添加性能分析接口"></a>为基于 HTTP 协议的网络服务添加性能分析接口</h1><p>在我们编写网络服务程序的时候，使用<code>net/http/pprof</code>包要比直接使用<code>runtime/pprof</code>包方便和实用很多，这个代码包可以为网络服务的监测提供有力的支撑</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"log"</span>
	<span class="token string">"net/http"</span>
	<span class="token boolean">_</span> <span class="token string">"net/http/pprof"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">"localhost:8082"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>直接访问<a target="_blank" rel="noopener" href="http://localhost:8082/debug/pprof">http://localhost:8082/debug/pprof</a> 可以看到<code>goroutine,threadcreate,heap, allocs,block,mutex</code>这6个指标的概要信息。它们都配有debug参数，默认值为0，可以通过改变debug的值改变概要信息的详细程度，如 <code>gotroutine</code>的URL是<code>http://localhost:8082/debug/pprof/goroutine?debug=1</code></p>
<p>当访问<a target="_blank" rel="noopener" href="http://localhost:8082/debug/pprof/profile">http://localhost:8082/debug/pprof/profile</a> 时，程序会执行对 CPU 概要信息的采样，可以通过加入参数<code>seconds</code>来控制对cpu的访问时间(默认是30秒)，当采样结束后，会提示你下载概要文件。你也可以执行下面命令，直接读取概要文件</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> tool pprof http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">6060</span><span class="token operator">/</span>debug<span class="token operator">/</span>pprof<span class="token operator">/</span>profile?seconds<span class="token operator">=</span><span class="token number">60</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h1 id="要回答的问题"><a href="#要回答的问题" class="headerlink" title="要回答的问题"></a>要回答的问题</h1><p><em><strong>先写结论，便于接下来的阅读与理解</strong></em></p>
<h2 id="基准测试与剖析的区别"><a href="#基准测试与剖析的区别" class="headerlink" title="基准测试与剖析的区别"></a>基准测试与剖析的区别</h2><p>基准测试可以用来衡量一个程序的性能，如果想让程序运行的更快，或对性能不理想的程序进行提升，基准测试无法给出从哪里可以进行优化。</p>
<p>通过剖析，可以找出程序性能瓶颈所在，从而有针对性的对程序进行优化，提高性能。不要过早的进行优化，97%的场景，都不需要过早优化或根本就不需要优化，我们要做的仅是让程序可以正常运行即可。</p>
<h2 id="剖析是如何进行的"><a href="#剖析是如何进行的" class="headerlink" title="剖析是如何进行的"></a>剖析是如何进行的</h2><p>剖析就是在程序执行期间进行一些自动抽样，在结束时进行推断，最后把统计结果保存为剖析数据文件，供剖析工具使用。Go 语言支持多种类型的剖析性能分析，可以通过go test 工具或调用Go的runtime 性能分析API(启用运行时剖析)，对程序进行剖析。</p>
<h2 id="需要对哪些代码进行剖析"><a href="#需要对哪些代码进行剖析" class="headerlink" title="需要对哪些代码进行剖析"></a>需要对哪些代码进行剖析</h2><p>要对程序的主要功能，关键部分进行基准测试，然后对其进行剖析，功能测试不应该参与进来，使用 <code>-run=None</code>，禁止功能测试的运行</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/golang-test-example/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
      <meta itemprop="description" content="雅思, 四级, 六级, 英语, 后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 睡月花儿">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/golang-test-example/" class="post-title-link" itemprop="url">go 语言 测试 示例函数</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-08-12 17:23:22" itemprop="dateCreated datePublished" datetime="2021-08-12T17:23:22+00:00">2021-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/golang/" itemprop="url" rel="index"><span itemprop="name">golang</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="示例函数"><a href="#示例函数" class="headerlink" title="示例函数"></a>示例函数</h1><p>以<code>Example</code>开头，后面加对应的函数名，示例没有参数列表与返回值列表</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">ExampleFibMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>后缀<code>FibMap</code>的首字母是大写，因为这个函数在源码中就是大写，必须与源码保持一致，如果写为<code>fibMap</code>，那么会提示<code> ExampleFibWithMap refers an unknown identifier</code>，即无法与对应的函数相关联。</p>
<p>要注意的是，因为<code>FibMap</code>方法是可导出的，它的示例函数要写为<code>ExampleFibMap</code>，如果方法是不可导出的，那么它的示例函数要写为<code>Example_xxx</code>的形式，如<code>fibWithMap</code>方法的示例函数可以命名为<code>Example_fibWithMap</code></p>
<h1 id="命名约定"><a href="#命名约定" class="headerlink" title="命名约定"></a>命名约定</h1><p>Go 语言通过大量的命名约定来简化工具的复杂度，规范代码的风格。对示例函数的命名有如下约定：</p>
<ul>
<li>包级别的示例函数，直接命名为 <code>func Example() &#123; ... &#125;</code></li>
<li>函数 F 的示例，命名为 <code>func ExampleF() &#123; ... &#125;</code></li>
<li>类型 T 的示例，命名为 <code>func ExampleT() &#123; ... &#125;</code></li>
<li>类型 T 上的 方法 M 的示例，命名为 <code>func ExampleT_M() &#123; ... &#125;</code></li>
</ul>
<p>如果同一个方法需要提供多个示例，可以在示例函数名称后附加一个不同的后缀来实现，但这种后缀必须以小写字母开头，大写也是可以的</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">Example_suffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">ExampleF_suffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">ExampleT_suffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">ExampleT_M_suffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<p>示例代码会放在单独的示例文件中，如<code>example_test.go</code></p>
<p><a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/master/src/bytes/example_test.go">https://github.com/golang/go/blob/master/src/bytes/example_test.go</a></p>
<h1 id="测试示例函数"><a href="#测试示例函数" class="headerlink" title="测试示例函数"></a>测试示例函数</h1><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 测试通过</span>
<span class="token keyword">go</span> test gott<span class="token operator">/</span>fib <span class="token operator">-</span>run<span class="token operator">=</span>ExampleFibMap
ok      gott<span class="token operator">/</span>fib        <span class="token number">0.008</span>s

<span class="token comment">// 测试不通过</span>
<span class="token keyword">go</span> test gott<span class="token operator">/</span>fib <span class="token operator">-</span>run<span class="token operator">=</span>ExampleFibMap
<span class="token operator">--</span><span class="token operator">-</span> FAIL<span class="token punctuation">:</span> ExampleFibMap <span class="token punctuation">(</span><span class="token number">0.00</span>s<span class="token punctuation">)</span>
got<span class="token punctuation">:</span>
<span class="token number">102334155</span>
want<span class="token punctuation">:</span> <span class="token comment">// 这里就是output 后面期待的值</span>
<span class="token number">102334156</span>
FAIL
FAIL    gott<span class="token operator">/</span>fib        <span class="token number">0.012</span>s
FAIL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有时候，输出顺序可能不确定，比如循环输出 map 的值，那么可以使用 <code>Unordered output</code> 开头的注释</p>
<h1 id="示例函数的作用"><a href="#示例函数的作用" class="headerlink" title="示例函数的作用"></a>示例函数的作用</h1><ol>
<li><p>作为文档使用</p>
<p>它可以直观的展示一个函数的用法与功能。根据<code>Example</code>的后缀部分，<code>godoc</code>文档服务会把示例函数关联到函数本身，在查询在线文档的时候，可以看到函数的具体用法及示例函数</p>
</li>
<li><p>验证函数是否正确</p>
<p>如果示例函数中包含<code>// Output</code>注释，那么在执行 go test 的时候，示例函数也会被运行，然后检查标准输出是否与注释匹配，不匹配则做为测试失败处理。如果示例函数中没有包含<code>// Output</code>注释，那么 go test 的时候，它不会被运行</p>
</li>
<li><p>可以在 godoc 提供的在线文档上显示，包括函数信息，示例函数</p>
</li>
</ol>
<h1 id="源码文件"><a href="#源码文件" class="headerlink" title="源码文件"></a>源码文件</h1><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// fib_test.go</span>
<span class="token keyword">func</span> <span class="token function">ExampleFibMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	num <span class="token operator">:=</span> <span class="token function">fibWithMap</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
	<span class="token comment">//Output:</span>
	<span class="token comment">//102334155</span>
	<span class="token comment">//hello</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">Example_fibWithMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	num <span class="token operator">:=</span> <span class="token function">fibWithMap</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
	<span class="token comment">//Output:</span>
	<span class="token comment">//102334155</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以有多个标准输出，与之对应的output也要有多个注释</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">FibMap</span><span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">fibWithMap</span><span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gagahappy.com/golang-test-convention/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/apple-touch-icon.png">
      <meta itemprop="name" content="戛戛Happy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="睡月花儿">
      <meta itemprop="description" content="雅思, 四级, 六级, 英语, 后端, 操作系统, 互联网, 程序开发, Linux, 数据库, MySql, Golang, Ruby">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 睡月花儿">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/golang-test-convention/" class="post-title-link" itemprop="url">go 语言 测试惯例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-24 15:37:16" itemprop="dateCreated datePublished" datetime="2021-07-24T15:37:16+00:00">2021-07-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-tag"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tags/golang/" itemprop="url" rel="index"><span itemprop="name">golang</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="运行某个包的测试"><a href="#运行某个包的测试" class="headerlink" title="运行某个包的测试"></a>运行某个包的测试</h1><p>不指定包名：go test 命令如果没有参数指定包，默认使用当前目录对应的包运行测试，且测试结果不会被缓存。第二次运行测试，测试结果中没有包含(cached)标示，说明测试结果没有被缓存，每次执行都会重新构建测试</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># gott/hello 当前目录为包名为 hello的目录</span>
go <span class="token builtin class-name">test</span>
PASS
ok  	gott/hello	<span class="token number">1</span>.025s

go <span class="token builtin class-name">test</span>
ok  	gott/hello	<span class="token number">1</span>.025s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>指定包名：测试结果会被缓存</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> gott/hello
ok  	gott/hello	<span class="token punctuation">(</span>cached<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h1 id="运行所有测试"><a href="#运行所有测试" class="headerlink" title="运行所有测试"></a>运行所有测试</h1><p>使用<code>go test ./...</code>标记运行所有包的测试，测试结果会被缓存</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> ./<span class="token punctuation">..</span>.
ok  	gott/hello	<span class="token number">1</span>.026s
ok  	gott/hi	<span class="token number">0</span>.040s
ok  	gott/pprint	<span class="token number">0</span>.017s
ok  	gott/prime	<span class="token number">0</span>.014s

go <span class="token builtin class-name">test</span> ./<span class="token punctuation">..</span>.
ok  	gott/hello	<span class="token punctuation">(</span>cached<span class="token punctuation">)</span>
ok  	gott/hi	<span class="token punctuation">(</span>cached<span class="token punctuation">)</span>
ok  	gott/pprint	<span class="token punctuation">(</span>cached<span class="token punctuation">)</span>
ok  	gott/prime	<span class="token punctuation">(</span>cached<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="有效的记录测试失败信息"><a href="#有效的记录测试失败信息" class="headerlink" title="有效的记录测试失败信息"></a>有效的记录测试失败信息</h1><p>测试失败的信息一般的形式是“f(x) = y, want z”，其中f(x)解释了失败的操作和对应的输入，y是实际的运行结果，z是期望的正确的结果。比起那些失败就打印满屏的堆栈信息的错误日志，这种记录格式使得测试人员很容易定位到问题所在，甚至都不需要去看源码文件。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">got <span class="token operator">:=</span> <span class="token function">sum</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> x2<span class="token punctuation">)</span>
<span class="token keyword">if</span> got <span class="token operator">!=</span> want <span class="token punctuation">&#123;</span>
	t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"sum(%d, %d) = %d, want %d"</span><span class="token punctuation">,</span> x1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> got<span class="token punctuation">,</span> want<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="随机测试如何预判结果"><a href="#随机测试如何预判结果" class="headerlink" title="随机测试如何预判结果"></a>随机测试如何预判结果</h1><p>一种方法是编写另一个对照函数，使用简单和清晰的算法，虽然效率较低但是行为和要测试的函数是一致的，然后针对相同的随机输入检查两者的输出结果。</p>
<p>第二种是生成的随机输入的数据遵循特定的模式，这样我们就可以知道期望的输出的模式。比如基于随机种子生成需要的大量数据，测试日志中不用去记录这些大量的数据，只需要记录这个随机种子即可，之后可以根据这个种子重现失败的测试用例，查找代码问题所在</p>
<h1 id="测试中的异常"><a href="#测试中的异常" class="headerlink" title="测试中的异常"></a>测试中的异常</h1><p>在测试代码中不要调用 <code>log.Fatal</code> 或 <code>os.Exit</code> ，调用这类函数会导致整个测试提前退出，后面的测试都将无法运行。调用这些函数的特权应该放在 <code>main</code> 函数中。如果真的有意外发生导致测试过程中发生 <code>panic</code> 异常，那么在测试中应该尝试用 <code>recover</code> 捕获异常，并记录下来，然后将当前测试当作失败处理(即调用<code>t.Effor/t.Fail/t.FailNow之类的方法</code>)。</p>
<p>在运行测试的时候，应该确保所有测试都得到运行，这样当测试运行结束后，就可以得到所有失败的测试用例的信息，而不是在某个测试失败后，就停止运行其后面的测试。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TestLogFatal</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"Test encounter a fatal"</span><span class="token punctuation">)</span>
	<span class="token comment">// os.Exit(2)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">TestPrint</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"just Print"</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">"GOROOT"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>由于调用了<code>log.Fatal</code>或<code>os.Exit</code>，在<code>TestLogFatal()</code>后面的测试用例都不会被运行</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token builtin class-name">test</span> -v  gott/hello
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestLogFatal
<span class="token number">2021</span>/07/24 <span class="token number">17</span>:34:02 Test encounter a fatal
FAIL    gott/hello      <span class="token number">0</span>.007s
FAIL
<span class="token comment"># 没有打印 TestPrint()的测试日志</span>

<span class="token comment"># 把 TestPrint()放到 TestLogFatal()的前面</span>
 go <span class="token builtin class-name">test</span> -v  gott/hello
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestPrint
    hello_test.go:24: just Print
    hello_test.go:25: /Users/ga/m/opt/go/go_root
--- PASS: TestPrint <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestLogFatal
<span class="token number">2021</span>/07/24 <span class="token number">17</span>:37:04 Test encounter a fatal
FAIL    gott/hello      <span class="token number">0</span>.013s
FAIL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>TestPrint 可以运行，但 TestLogFatal 之后的测试用例都不会得到运行，在调用 log.Fatal 函数后，整个测试程序就退出了</p>
<h1 id="mock-测试中的敏感对象"><a href="#mock-测试中的敏感对象" class="headerlink" title="mock 测试中的敏感对象"></a>mock 测试中的敏感对象</h1><ul>
<li><p>对外部环境的依赖</p>
<p>数据库的连接，第三方接口的调用</p>
</li>
<li><p>导致生产代码产生一些调试信息的钩子函数</p>
</li>
<li><p>诱导生产代码进入某些重要状态的改变</p>
<p>超时、错误，甚至是一些刻意制造的并发行为等因素</p>
</li>
</ul>
<p>应该对以上这些对象进行仿造(mock)，从而得到一个纯净的测试环境。有一个需要注意的地方，如果在某个测试用例中mock了某些对象，在这个测试用例运行完成后，要对这些mock的对象进行还原，以避免影响其它测试用例。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TestCheckQuotaNotifiesUser</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Save and restore original notifyUser.</span>
  	<span class="token comment">// 保存 及 恢复 mock的原始对象</span>
    saved <span class="token operator">:=</span> notifyUser
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> notifyUser <span class="token operator">=</span> saved <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Install the test's fake notifyUser.</span>
    <span class="token keyword">var</span> notifiedUser<span class="token punctuation">,</span> notifiedMsg <span class="token builtin">string</span>
    notifyUser <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> msg <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        notifiedUser<span class="token punctuation">,</span> notifiedMsg <span class="token operator">=</span> user<span class="token punctuation">,</span> msg
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// ...rest of test...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>先把要mock的对象保存起来，等测试完成后，再对其进行恢复，可以使用<code>defer</code>语句来延后执行处理恢复的代码</p>
<h1 id="避免脆弱的测试"><a href="#避免脆弱的测试" class="headerlink" title="避免脆弱的测试"></a>避免脆弱的测试</h1><ul>
<li><p>一个好的测试不应该在程序仅仅只是做了微小变化就失败</p>
</li>
<li><p>一个好的测试不应该在遇到一点小错误时就立刻退出测试，它应该尝试报告更多的相关的错误信息，因为我们可能从多个失败测试的模式中发现错误产生的规律</p>
</li>
<li><p>一个好的测试的关键是首先实现你期望的具体行为，然后才是考虑简化测试代码、避免重复。如果直接从抽象、通用的测试库着手，很难取得良好结果。</p>
</li>
<li><p>保持测试代码的简洁和内部结构的稳定，特别是对断言部分要有所选择，比如不要对字符串进行全字匹配，而是针对那些在项目的发展中是比较稳定不变的子串</p>
</li>
<li><p>测试时涉及到对全局变量产生修改的那些测试，要以串行的方式运行，不能并行运行</p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备10044755号 </a>
      <img src="/beian-gongan.png" alt=""><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010902000669" rel="noopener" target="_blank">京公网安备 11010902000669号 </a>
  </div>

<div class="copyright">
  &copy; 2009 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">戛戛Happy</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"moonfox","repo":"gitalk","client_id":"2a9c7ba27dd4a9376f8c","client_secret":"cb4fa8779f853f735779a518c57e894a8ee30b09","admin_user":"moonfox","distraction_free_mode":false,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.min.js","integrity":"sha256-Pmj85ojLaPOWwRtlMJwmezB/Qg8BzvJp5eTzvXaYAfA="},"path_md5":"index.html"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
